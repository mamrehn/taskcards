<!doctype html><html lang="de"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; connect-src 'self' wss://qlash-server.fly.dev; img-src 'self' data:; font-src 'self'; base-uri 'self'; form-action 'self';"><meta name="referrer" content="no-referrer"><title>Multiplayer Quiz</title><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script><style>:root{--surface-color:#ffffff;--surface-secondary:#f8f9fa;--text-color:#333;--text-muted:#6c757d;--border-color:#dee2e6;--input-border:#ced4da;--input-bg:#ffffff;--shadow-color:rgba(0, 0, 0, 0.1)}[data-theme=dark]{--surface-color:#1e1e2e;--surface-secondary:#2a2a3c;--text-color:#e0e0e0;--text-muted:#a0a0b0;--border-color:#3a3a4c;--input-border:#4a4a5c;--input-bg:#2a2a3c;--shadow-color:rgba(0, 0, 0, 0.3)}html.theme-transition,html.theme-transition *,html.theme-transition ::after,html.theme-transition ::before{transition:background-color .3s ease,color .3s ease,border-color .3s ease,box-shadow .3s ease!important;transition-delay:0s!important}.theme-toggle{position:fixed;bottom:1rem;right:1rem;width:44px;height:44px;border-radius:50%;border:2px solid rgba(128,128,128,.3);background-color:rgba(255,255,255,.9);cursor:pointer;z-index:9999;display:flex;align-items:center;justify-content:center;font-size:1.3rem;box-shadow:0 2px 8px rgba(0,0,0,.15);transition:background-color .3s,transform .2s;-webkit-tap-highlight-color:transparent;padding:0;line-height:1}.theme-toggle:hover{transform:scale(1.1)}.theme-toggle:active{transform:scale(.95)}[data-theme=dark] .theme-toggle{background-color:rgba(50,50,50,.9);border-color:rgba(128,128,128,.4)}</style><script>(()=>{var e,t="taskcards-theme",n="dark",o="light";function a(e){document.documentElement.setAttribute("data-theme",e),d(e);var t=document.querySelector('meta[name="theme-color"]');t&&t.setAttribute("content",e===n?"#1e1e2e":"#3498db")}function d(e){var t=document.querySelector(".theme-toggle");t&&(t.textContent=e===n?"☀️":"🌙",t.setAttribute("aria-label",e===n?"Zum hellen Modus wechseln":"Zum dunklen Modus wechseln"))}function c(){var e=(document.documentElement.getAttribute("data-theme")||o)===n?o:n;document.documentElement.classList.add("theme-transition"),a(e),localStorage.setItem(t,e),setTimeout(function(){document.documentElement.classList.remove("theme-transition")},350)}function m(){var e=document.createElement("button");e.className="theme-toggle",e.type="button",e.addEventListener("click",c),document.body.appendChild(e),d(document.documentElement.getAttribute("data-theme")||o)}a((e=localStorage.getItem(t))===n||e===o?e:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?n:o),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(e){localStorage.getItem(t)||a(e.matches?n:o)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",m):m()})()</script><script>function sanitizeHTML(t){var e;return"string"!=typeof t?"":((e=document.createElement("div")).textContent=t,e.innerHTML)}function sanitizeInput(t,e=1e3){if("string"!=typeof t)return"";let n=t.trim();return n=(n=n.length>e?n.substring(0,e):n).replace(/\0/g,"")}function sanitizePlayerName(t){if("string"!=typeof t)return"";let e=sanitizeInput(t,50);return e=e.replace(/[^a-zA-Z0-9äöüÄÖÜß\s\-_\.]/g,"")}function sanitizeRoomCode(t){return"string"!=typeof t?"":t.toUpperCase().replace(/[^A-Z0-9]/g,"").substring(0,10)}function sanitizeQuestionText(t){return"string"!=typeof t?"":sanitizeInput(sanitizeHTML(t),5e3)}function sanitizeJSON(t,e=5242880){if("string"!=typeof t)return null;if(new Blob([t]).size>e)return console.error("JSON file too large"),null;try{return JSON.parse(t)}catch(t){return console.error("Invalid JSON:",t),null}}function sanitizeURL(t){if("string"==typeof t)try{var e=new URL(t);if("http:"===e.protocol||"https:"===e.protocol)return t}catch(t){}return""}function createSafeTextNode(t){return document.createTextNode(sanitizeInput(t))}function setSafeText(t,e){t&&"string"==typeof e&&(t.textContent=sanitizeInput(e))}function isValidEmail(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)}</script><style>@keyframes confetti-fall{0%{transform:translateY(-100px) rotateZ(0);opacity:0}10%{opacity:1}to{transform:translateY(100vh) rotateZ(720deg);opacity:0}}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}:root{--primary-color:#46178f;--secondary-color:#5e22b2;--accent-color:#ff3355;--light-color:#f7f7f7;--dark-color:#333;--correct-color:#00c853;--wrong-color:#ff3d00;--quiz-surface:#f1f1f1;--quiz-surface-alt:#f0f0f0;--quiz-hover:#e9e9e9;--success-bg:#d4edda;--success-border:#c3e6cb}*{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif}body{background-color:var(--light-color);color:var(--dark-color);font-size:18px}h1{font-size:2rem}h2{font-size:1.7em}h3{font-size:1.5em}.container{max-width:1200px;margin:0 auto;padding:20px}header{color:#fff;padding:1rem;text-align:center;border-radius:8px;margin-bottom:2rem}.view{display:none}.active{display:block}.btn,input,select{margin:10px 0;border-radius:4px}.btn{background-color:var(--secondary-color);color:#fff;border:0;padding:12px 20px;cursor:pointer;font-size:1.1em;transition:background-color .3s}.btn:hover,header{background-color:var(--primary-color)}.btn-accent{background-color:var(--accent-color)}.btn-reconnect{background-color:transparent;color:var(--secondary-color);border:2px solid var(--secondary-color);font-size:.95em;margin-top:5px}.btn-reconnect:hover{background-color:var(--secondary-color);color:#fff}.btn-accent:hover{background-color:#e62b4c}.card{background-color:var(--surface-color);border-radius:8px;padding:20px;box-shadow:0 4px 6px var(--shadow-color);margin-bottom:20px}input,select{width:100%;padding:12px;border:1px solid var(--input-border);font-size:1em;background-color:var(--input-bg);color:var(--text-color)}.duration-range-row{display:flex;gap:15px;margin-top:8px}.duration-input-group{flex:1;display:flex;align-items:center;gap:8px}.duration-input-group label{white-space:nowrap;font-weight:500}.duration-input{width:80px}#question-form,#questions-list{margin-top:20px}.option-group{display:flex;flex-wrap:wrap;align-items:center;margin-bottom:10px}.option-group input[type=text]{flex-grow:1;margin-right:10px;min-width:150px}.option-group input[type=checkbox]{width:auto;margin-left:10px}.option-group label{margin-left:5px}.option-btn,.question-item{background-color:var(--quiz-surface);padding:15px;border-radius:4px;margin-bottom:10px}.option-btn{display:block;width:100%;margin-bottom:8px;border:1px solid var(--input-border);border-radius:8px;background-color:var(--quiz-surface-alt);color:var(--text-color);text-align:left;cursor:pointer;transition:background-color .2s ease;font-size:1.1em}.option-btn:hover:not(:disabled){background-color:var(--quiz-hover)}.option-btn.selected{background-color:var(--secondary-color);color:#fff;border-color:var(--secondary-color)}.option-btn.correct,.option-btn.correct-answer{background-color:var(--correct-color);color:#fff;border-color:var(--correct-color);font-weight:700}.option-btn.incorrect,.option-btn.incorrect-answer.selected{background-color:var(--wrong-color);color:#fff;border-color:var(--wrong-color);font-weight:700}.host-options-list{margin-top:15px;padding:0;list-style:none}.host-options-list li{background-color:var(--quiz-surface-alt);border:1px solid var(--input-border);padding:10px;margin-bottom:8px;border-radius:8px;font-size:1.1em}.host-options-list li.correct{background-color:var(--success-bg);border-color:var(--success-border);font-weight:700}#result-display{text-align:center;font-size:1.5rem;margin:20px 0;padding:15px;border-radius:8px}#result-display.correct{background-color:rgba(0,200,83,.2);color:var(--correct-color)}#result-display.incorrect{background-color:rgba(255,61,0,.2);color:var(--wrong-color)}#result-display .correct{color:var(--correct-color);font-weight:700}#result-display .incorrect,.score-gained{color:var(--wrong-color);font-weight:700}#result-display .player-selected{text-decoration:underline;font-weight:700}#result-display .correct-not-selected{font-weight:700;font-style:italic;color:var(--correct-color)}.score-gained{color:var(--correct-color);margin:0 4px}.scoreboard{margin-top:25px;padding-top:20px;border-top:1px solid var(--border-color)}.scoreboard h4{margin-bottom:15px;font-size:1.4em}.scoreboard ol{padding-left:25px}.scoreboard li{margin-bottom:8px;font-size:1.2em}.scoreboard-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed var(--border-color)}.scoreboard-item:last-child{border-bottom:none}#large-qrcode,.qr-modal-overlay{display:flex;justify-content:center;align-items:center}.qr-modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1000}.qr-modal-content{background:var(--surface-color);padding:30px;border-radius:12px;position:relative;text-align:center;box-shadow:0 8px 16px rgba(0,0,0,.3);max-width:90%}.qr-modal-close{position:absolute;top:15px;right:15px;background:0 0;border:0;font-size:2.2em;cursor:pointer;color:var(--text-color);line-height:1}.qr-modal-close:hover{color:#000}#large-qrcode{margin:30px auto}#large-qrcode img{width:300px;max-width:100%;height:auto}#qrcode{margin:20px auto;text-align:center}.leaderboard-item.rank-1,.scoreboard-item.rank-1{background-color:#ffeb3b;font-weight:700;border-color:#fbc02d}.leaderboard-item.rank-2,.scoreboard-item.rank-2{background-color:#e0e0e0;font-weight:700;border-color:#bdbdbd}.leaderboard-item.rank-3,.scoreboard-item.rank-3{background-color:#ffccbc;font-weight:700;border-color:#e64a19}.hidden{display:none!important}#confetti-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden;z-index:999}.confetti-piece{position:absolute;width:10px;height:10px;background-color:var(--confetti-color);opacity:0;animation:confetti-fall 3s ease-out forwards}#leaderboard{margin-top:20px}.leaderboard-item{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border-color)}.leaderboard-item:last-child{border-bottom:none}.loader{border:5px solid var(--border-color);border-top:5px solid var(--secondary-color);border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:20px auto}.timer-bar{height:10px;background-color:var(--accent-color);width:100%;border-radius:5px;margin-top:10px;transition:width 1s linear}.players-list{margin:20px 0}.player-item{background-color:var(--quiz-surface);padding:10px;border-radius:4px;margin-bottom:5px}.flex-row{display:flex;gap:10px}.correct-answers{margin-top:10px;color:var(--correct-color);font-weight:700}.score-display{font-size:1.2rem;font-weight:700;text-align:center;margin:15px 0}.question-counter{text-align:center;margin-bottom:15px;color:var(--secondary-color)}.file-input-container{position:relative;overflow:hidden;display:inline-block}.file-input-container input[type=file]{position:absolute;font-size:100px;right:0;top:0;opacity:0;cursor:pointer}.file-input-label{display:inline-block;padding:10px 20px;background-color:var(--secondary-color);color:#fff;border-radius:4px;cursor:pointer}@media (max-width:600px){body{font-size:16px}h1{font-size:2em}h2{font-size:1.6em}h3{font-size:1.3em}.container{padding:15px}.card{padding:20px}input[type=number],input[type=text]{padding:12px;font-size:1em}.btn{padding:12px 20px;font-size:1.1em}.option-btn{padding:12px}.host-options-list li{padding:8px;font-size:1em}.scoreboard h4{font-size:1.2em}.option-btn,.scoreboard li{font-size:1em}.qr-modal-content{padding:20px}#large-qrcode img{width:250px;height:250px}}.player-item.disconnected{opacity:.5;font-style:italic}.toast-notification{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(20px);padding:12px 24px;border-radius:8px;color:#fff;font-weight:500;z-index:10001;opacity:0;transition:opacity .3s ease,transform .3s ease;max-width:90%;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.3)}.toast-notification.show{opacity:1;transform:translateX(-50%) translateY(0)}.toast-info{background-color:var(--secondary-color)}.toast-error{background-color:var(--wrong-color)}.footer-link{color:var(--dark-color);text-decoration:none}.footer-link:hover{text-decoration:underline}.qr-error{color:var(--wrong-color)}[data-theme=dark]{--primary-color:#7b4ec9;--secondary-color:#8e5fd6;--accent-color:#ff6b7f;--light-color:#1e1e2e;--dark-color:#e0e0e0;--correct-color:#4caf50;--wrong-color:#ff6e40;--quiz-surface:#2a2a3c;--quiz-surface-alt:#323248;--quiz-hover:#3a3a50;--success-bg:rgba(76, 175, 80, 0.2);--success-border:rgba(76, 175, 80, 0.3)}[data-theme=dark] .qr-modal-close:hover{color:#fff}[data-theme=dark] .btn-accent:hover{background-color:#e6556b}[data-theme=dark] .leaderboard-item.rank-1,[data-theme=dark] .scoreboard-item.rank-1{background-color:rgba(255,235,59,.25);border-color:rgba(251,192,45,.4);color:#ffeb3b}[data-theme=dark] .leaderboard-item.rank-2,[data-theme=dark] .scoreboard-item.rank-2{background-color:rgba(224,224,224,.15);border-color:rgba(189,189,189,.3);color:#e0e0e0}[data-theme=dark] .leaderboard-item.rank-3,[data-theme=dark] .scoreboard-item.rank-3{background-color:rgba(255,204,188,.2);border-color:rgba(230,74,25,.3);color:#ffccbc}</style></head><body><div class="container"><header><h1>Multiplayer Quiz</h1></header><div id="role-selection" class="view active card"><h2>Wähle deine Rolle</h2><button id="host-btn" class="btn">Quiz hosten</button> <button id="player-btn" class="btn">Quiz beitreten</button> <button id="reconnect-host-btn" class="btn btn-reconnect hidden">Erneut als Host verbinden</button> <button id="reconnect-player-btn" class="btn btn-reconnect hidden">Erneut zum Quiz verbinden</button></div><div id="host-view" class="view card"><h2 id="host-view-heading">Quiz hosten</h2><div id="host-setup"><div class="duration-setting" style="margin-top:15px"><label>Fragedauer (Sekunden):</label><div class="duration-range-row"><div class="duration-input-group"><label for="question-duration-min">Min:</label> <input type="number" id="question-duration-min" value="20" min="5" max="60" class="duration-input"></div><div class="duration-input-group"><label for="question-duration-max">Max:</label> <input type="number" id="question-duration-max" value="40" min="5" max="60" class="duration-input"></div></div></div><button id="start-quiz-btn" class="btn btn-accent" style="margin-top:10px">Quiz starten</button><div class="file-input-container"><label for="json-file" class="file-input-label">Fragen importieren (JSON)</label> <input type="file" id="json-file" accept=".json"></div><p id="file-status"></p><h3>Oder Fragen manuell erstellen:</h3><form id="question-form"><div><label for="question-text">Frage:</label> <input id="question-text" placeholder="Gib deine Frage ein"></div><div class="option-group"><input class="option-input" placeholder="Option 1"> <input type="checkbox" class="correct-checkbox"> <label>Richtig</label></div><div class="option-group"><input class="option-input" placeholder="Option 2"> <input type="checkbox" class="correct-checkbox"> <label>Richtig</label></div><button type="button" id="add-option-btn" class="btn">Option hinzufügen</button> <button type="submit" class="btn">Frage hinzufügen</button></form><div id="questions-list"><h3>Hinzugefügte Fragen:</h3><div id="questions-container"><p>Noch keine Fragen hinzugefügt</p></div></div></div><div id="qr-container" class="hidden"><h3>QR-Code scannen oder URL eingeben, um beizutreten:</h3><div id="qrcode" style="cursor:pointer"></div><p>URL eingeben: <a id="join-link" href="#" target="_blank"></a></p><p>Dann Code eingeben: <span id="room-id" style="font-size:1.4em;font-weight:700;letter-spacing:.1em"></span></p><p>Verbundene Spieler: <span id="player-count">0</span></p><div class="players-list" id="players-list"></div><button id="start-questions-btn" class="btn btn-accent hidden">Fragen starten</button></div><div id="host-question-display" class="hidden"><h3 id="current-question-text"></h3><ul id="host-current-options" class="host-options-list"></ul><div class="question-counter" id="question-counter"></div><div class="timer-bar-container"><div class="timer-bar" id="timer-bar"></div></div><p>Spieler haben geantwortet: <span id="answers-count">0</span>/<span id="total-players">0</span></p><div id="host-scoreboard" class="scoreboard hidden"><h4>Aktuelle Rangliste (Top 10)</h4><ol id="scoreboard-list"></ol></div><button id="show-next-btn" class="btn hidden">Nächste Frage</button> <button id="show-results-btn" class="btn hidden">Endergebnisse anzeigen</button></div><div id="host-results" class="view card hidden"><h3>Endgültige Rangliste</h3><div id="leaderboard"></div><button id="new-quiz-btn" class="btn">Neues Quiz hosten</button></div></div><div id="player-view" class="view card"><div id="join-form"><h2>Einem Quiz beitreten</h2><input id="room-code-input" placeholder="Host-ID eingeben oder QR scannen"> <input id="player-name-input" placeholder="Dein Name"> <button id="join-btn" class="btn">Quiz beitreten</button><p>Oder scanne den vom Host bereitgestellten QR-Code</p></div><div id="waiting-room" class="hidden"><h2>Warten auf den Quizstart</h2><p id="waiting-message">Du bist dem Raum erfolgreich beigetreten!</p><div class="loader"></div><p>Der Host wird das Quiz bald starten...</p></div><div id="player-question" class="hidden"><h3 id="player-question-text"></h3><div class="question-counter" id="player-question-counter"></div><div class="timer-bar-container"><div class="timer-bar" id="player-timer-bar"></div></div><div id="options-container"></div><button id="submit-answer-btn" class="btn hidden">Antwort absenden</button></div><div id="player-result" class="hidden"><div id="result-display"></div><div class="score-display">Deine Punktzahl: <span id="player-score">0</span></div><p id="waiting-for-next">Warten auf nächste Frage...</p></div><div id="player-final-result" class="view card hidden"><h2>Quiz beendet!</h2><div id="player-leaderboard-container" style="margin-bottom:15px"></div><div class="score-display">Deine Endpunktzahl: <span id="final-score">0</span></div><p>Vielen Dank fürs Mitspielen!</p><button id="play-again-btn" class="btn">Nochmal spielen</button></div></div></div><div id="qr-modal-overlay" class="qr-modal-overlay hidden"><div id="qr-modal-content" class="qr-modal-content"><button id="qr-modal-close" class="qr-modal-close">&times;</button><h3>Zum Beitreten scannen oder URL eingeben</h3><div id="large-qrcode"></div><p>URL eingeben: <a id="join-link-modal" href="#" target="_blank"></a></p><p>Dann Code eingeben: <span id="modal-room-id" style="font-size:1.4em;font-weight:700;letter-spacing:.1em"></span></p></div></div><div id="confetti-container"></div><footer style="text-align:center;margin-top:20px;font-size:.9em"><p><a href="datenschutz.html" class="footer-link">Datenschutzhinweise</a></p></footer><script>let RAW_URL="wss://qlash-server.fly.dev",WS_URL="undefined"!=typeof window&&window.WS_URL&&"wss://qlash-server.fly.dev"!==window.WS_URL?window.WS_URL:"wss://qlash-server.fly.dev";function showMessage(e,t="info"){var n=document.getElementById("toast-notification");n&&n.remove();let s=document.createElement("div");s.id="toast-notification",s.className="toast-notification toast-"+t,s.textContent=e,document.body.appendChild(s),requestAnimationFrame(()=>s.classList.add("show")),setTimeout(()=>{s.classList.remove("show"),setTimeout(()=>{s.parentNode&&s.remove()},300)},4e3)}function showView(e){document.querySelectorAll(".view").forEach(e=>e.classList.remove("active"));var t=document.getElementById(e);t?t.classList.add("active"):console.error("View not found:",e),"host-view"!==e&&"player-view"!==e||document.getElementById("role-selection").classList.add("hidden")}function generateAlphanumericId(t){let n="";for(let e=0;e<t;e++)n+="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(Math.floor(36*Math.random()));return n}function shuffleArray(t){for(let e=t.length-1;0<e;e--){var n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}}function connectWithRetry(i,a=3){return new Promise((s,o)=>{let r=0;!function e(){r++;let t=new WebSocket(i),n=setTimeout(()=>{t.onopen=null,t.onerror=null,t.close(),r<a?(console.log(`WebSocket connection attempt ${r} timed out, retrying...`),setTimeout(e,2e3*r)):o(new Error("WebSocket connection failed after retries"))},1e4);t.onopen=()=>{clearTimeout(n),s(t)},t.onerror=()=>{clearTimeout(n),t.onopen=null,r<a?(console.log(`WebSocket connection attempt ${r} failed, retrying...`),setTimeout(e,2e3*r)):o(new Error("WebSocket connection failed after retries"))}}()})}let qrModalOverlay=null,qrModalCloseBtn=null,largeQrcodeContainer=null,modalRoomIdSpan=null,hostGlobalQuizState=(document.addEventListener("DOMContentLoaded",()=>{if(WS_URL&&WS_URL.startsWith("ws")){qrModalOverlay=document.getElementById("qr-modal-overlay"),qrModalCloseBtn=document.getElementById("qr-modal-close"),largeQrcodeContainer=document.getElementById("large-qrcode"),modalRoomIdSpan=document.getElementById("modal-room-id"),qrModalCloseBtn&&qrModalCloseBtn.addEventListener("click",()=>{qrModalOverlay&&qrModalOverlay.classList.add("hidden")}),qrModalOverlay&&qrModalOverlay.addEventListener("click",e=>{e.target===qrModalOverlay&&qrModalOverlay.classList.add("hidden")}),document.getElementById("host-btn").addEventListener("click",()=>{showView("host-view"),initializeHostFeatures()}),document.getElementById("player-btn").addEventListener("click",()=>{showView("player-view"),initializePlayerFeatures()});var s=new URLSearchParams(window.location.search).get("host");s?(showView("player-view"),initializePlayerFeatures(),document.getElementById("room-code-input").value=s):showView("role-selection");let t=document.getElementById("reconnect-host-btn"),n=document.getElementById("reconnect-player-btn"),e=getActiveSession();e&&"host"===e.role?t.classList.remove("hidden"):e&&"player"===e.role&&n.classList.remove("hidden"),t.addEventListener("click",()=>{var e=getActiveSession();e&&"host"===e.role?(showView("host-view"),initializeHostFeatures({roomId:e.roomId,sessionId:e.sessionId})):(showMessage("Keine aktive Host-Sitzung gefunden.","error"),t.classList.add("hidden"))}),n.addEventListener("click",()=>{var e=getActiveSession();e&&"player"===e.role?(showView("player-view"),initializePlayerFeatures({roomId:e.roomId,sessionId:e.sessionId,playerName:e.playerName})):(showMessage("Keine aktive Spieler-Sitzung gefunden.","error"),n.classList.add("hidden"))}),document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&(hostWs&&hostWs.readyState!==WebSocket.OPEN&&hostRoomId&&reconnectHostWs(),playerWs)&&playerWs.readyState!==WebSocket.OPEN&&playerRoomId&&reconnectPlayerWs()})}else console.error("WebSocket server URL not configured or invalid:",WS_URL),showMessage("Server-URL nicht konfiguriert. Bitte überprüfe die Konfiguration.","error")}),null),hostWs=null,hostSessionId=null,isHostInitialized=!1,hostTimerInterval=null,hostQuestionStartTime=null,hostRoomId=null,hostViewHeading=null,hostBeforeUnloadHandler=null,hostWsReconnectAttempts=0,hostPendingQuestion=null,HOST_MAX_RECONNECT_ATTEMPTS=30,RECONNECT_DELAY_MS=1e4;function getNonHostPlayers(){return hostGlobalQuizState?Object.values(hostGlobalQuizState.players):[]}function getConnectedNonHostPlayers(){return getNonHostPlayers().filter(e=>!1!==e.isConnected)}function getNonHostPlayerCount(){return getConnectedNonHostPlayers().length}async function initializeHostFeatures(e){let l=hostGlobalQuizState=hostGlobalQuizState||{currentQuestionIndex:0,questions:[],shuffledQuestions:[],players:{},answersReceived:0,isQuestionActive:!1,roomId:null,durationMin:20,durationMax:40,questionDurations:[]},t=document.getElementById("json-file"),n=document.getElementById("file-status"),r=document.getElementById("question-form"),i=document.getElementById("question-text"),s=document.getElementById("add-option-btn"),o=document.getElementById("questions-container"),a=document.getElementById("question-duration-min"),d=document.getElementById("question-duration-max"),c=document.getElementById("start-quiz-btn"),u=document.getElementById("qr-container"),h=document.getElementById("host-setup"),m=document.getElementById("qrcode"),g=document.getElementById("room-id"),y=document.getElementById("join-link"),p=document.getElementById("join-link-modal"),O=document.getElementById("player-count"),I=document.getElementById("players-list"),Q=document.getElementById("start-questions-btn"),f=document.getElementById("host-question-display"),k=document.getElementById("current-question-text"),_=document.getElementById("host-current-options"),P=document.getElementById("question-counter"),z=document.getElementById("timer-bar"),v=document.getElementById("answers-count"),S=document.getElementById("total-players"),V=document.getElementById("host-scoreboard"),w=document.getElementById("scoreboard-list"),E=document.getElementById("show-next-btn"),L=document.getElementById("show-results-btn"),b=document.getElementById("host-results"),C=document.getElementById("leaderboard"),$=document.getElementById("new-quiz-btn");if(hostViewHeading=document.getElementById("host-view-heading"),a.value=l.durationMin,d.value=l.durationMax,isHostInitialized||(t.addEventListener("change",e=>{var t,e=e.target.files[0];e&&((t=new FileReader).onload=e=>{try{var t=JSON.parse(e.target.result);t&&Array.isArray(t)&&t.every(e=>e.question&&e.options&&e.correct)?l.questions=t:t&&t.cards&&Array.isArray(t.cards)?l.questions=t.cards:(n.textContent='Ungültiges JSON. Erwartet wird ein Array von Fragen oder eine "Karten"-Struktur.',l.questions=[]),n.textContent=0<l.questions.length?`Importiert ${l.questions.length} Fragen.`:n.textContent||"Keine Fragen im JSON gefunden.",M()}catch(e){console.error("Error parsing JSON:",e),n.textContent="Fehler beim Parsen des JSON. Format überprüfen.",l.questions=[],M()}},t.readAsText(e))}),s.addEventListener("click",()=>{var e=r.querySelectorAll(".option-group").length+1,t=document.createElement("div");t.className="option-group",t.innerHTML=`<input type="text" class="option-input" placeholder="Option ${e}"><input type="checkbox" class="correct-checkbox"><label>Richtig</label>`,r.insertBefore(t,s)}),r.addEventListener("submit",t=>{t.preventDefault();t=i.value.trim();if(t){let e=r.querySelectorAll(".option-input"),s=[],o=[];e.forEach(e=>{var t,n=e.value.trim();n&&(t=s.length,s.push(n),n=e.parentElement.querySelector(".correct-checkbox"))&&n.checked&&o.push(t)}),s.length<2?showMessage("Bitte füge mindestens zwei gültige Optionen hinzu","error"):0!==o.length?(l.questions.push({question:t,options:s,correct:o}),i.value="",r.querySelectorAll(".option-group").forEach((e,t)=>{var n=e.querySelector(".option-input"),s=e.querySelector(".correct-checkbox");t<2?(n&&(n.value=""),s&&(s.checked=!1)):e.remove()}),M()):showMessage("Bitte wähle mindestens eine richtige Antwort aus","error")}else showMessage("Bitte gebe eine Frage ein","error")}),c.addEventListener("click",async()=>{if(0===l.questions.length)showMessage("Bitte füge mindestens eine Frage hinzu.","error");else{let s=parseInt(a.value,10),o=parseInt(d.value,10);if(isNaN(s)||isNaN(o)||s<5||80<o||s>o)showMessage("Bitte gültige Fragedauer eingeben: Min 5-80, Max >= Min.","error");else{for(let n=0;n<l.questions.length;n++){let e=l.questions[n];if(4e3<e.question.length)return void showMessage(`Frage ${n+1} ist zu lang (${e.question.length}/4000 Zeichen).`,"error");if(20<e.options.length)return void showMessage(`Frage ${n+1} hat zu viele Optionen (${e.options.length}/20).`,"error");let t=e.options.findIndex(e=>500<e.length);if(-1!==t)return void showMessage(`Frage ${n+1}, Option ${t+1} ist zu lang (${e.options[t].length}/500 Zeichen).`,"error")}l.durationMin=s,l.durationMax=o,l.shuffledQuestions=[...l.questions],shuffleArray(l.shuffledQuestions);let e=l.shuffledQuestions.map(e=>e.question.length+e.options.reduce((e,t)=>e+t.length,0)),t=Math.min(...e),n=Math.max(...e)-t;l.questionDurations=e.map(e=>0==n?Math.round((s+o)/2):(e=(e-t)/n,Math.round(s+e*(o-s)))),hostWsReconnectAttempts=0;try{hostWs=await connectWithRetry(WS_URL)}catch(e){return void await void showMessage("Server nicht erreichbar. Bitte versuche es später erneut.","error")}console.log("Host WebSocket connected"),hostWs.send(JSON.stringify({type:"create_room"})),hostWs.onmessage=e=>{let t;try{t=JSON.parse(e.data)}catch{return}T(t)},hostWs.onclose=()=>{console.log("Host WebSocket closed"),hostRoomId&&hostWsReconnectAttempts<HOST_MAX_RECONNECT_ATTEMPTS?(hostWsReconnectAttempts++,console.log(`Host reconnecting (${hostWsReconnectAttempts}/${HOST_MAX_RECONNECT_ATTEMPTS})...`),setTimeout(W,RECONNECT_DELAY_MS)):hostWsReconnectAttempts>=HOST_MAX_RECONNECT_ATTEMPTS&&showMessage("Verbindung zum Server verloren. Bitte lade die Seite neu.","error")},hostWs.onerror=e=>{console.error("Host WebSocket error:",e)}}}}),Q.addEventListener("click",async()=>{0!==getNonHostPlayerCount()?(u.classList.add("hidden"),f.classList.remove("hidden"),hostViewHeading&&hostViewHeading.classList.add("hidden"),l.currentQuestionIndex=0,await N()):showMessage("Es sind noch keine Spieler beigetreten!","info")}),E.addEventListener("click",async()=>{l.currentQuestionIndex++,await N()}),L.addEventListener("click",D),$.addEventListener("click",async()=>{if(clearActiveSession(),hostWs&&hostWs.readyState===WebSocket.OPEN)hostWs.send(JSON.stringify({type:"terminate"}));else if(hostRoomId&&hostSessionId)try{let e=hostRoomId,t=hostSessionId,n=new WebSocket(WS_URL);n.onopen=()=>{n.send(JSON.stringify({type:"reconnect_host",roomId:e,sessionId:t})),n.onmessage=()=>{n.send(JSON.stringify({type:"terminate"})),n.close()}},n.onerror=()=>n.close()}catch(e){}hostWs&&(hostWs.onclose=null,hostWs.close(),hostWs=null),hostRoomId=null,hostSessionId=null,hostGlobalQuizState=null,isHostInitialized=!1,n.textContent="",t&&(t.value=""),b.classList.add("hidden"),f.classList.add("hidden"),u.classList.add("hidden"),h.classList.remove("hidden"),document.getElementById("role-selection").classList.remove("hidden"),hostViewHeading&&hostViewHeading.classList.remove("hidden"),initializeHostFeatures()}),hostBeforeUnloadHandler&&window.removeEventListener("beforeunload",hostBeforeUnloadHandler),hostBeforeUnloadHandler=()=>{hostWs&&hostWs.close()},window.addEventListener("beforeunload",hostBeforeUnloadHandler),m.addEventListener("click",()=>{qrModalOverlay&&largeQrcodeContainer&&hostRoomId&&(qrModalOverlay.classList.remove("hidden"),largeQrcodeContainer.innerHTML="",new QRCode(largeQrcodeContainer,{text:y.href,width:300,height:300,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),modalRoomIdSpan.textContent=l.roomId)}),isHostInitialized=!0),M(),A(),hostRoomId)if(l.isQuestionActive||l.currentQuestionIndex<l.shuffledQuestions.length){h.classList.add("hidden"),u.classList.add("hidden"),b.classList.add("hidden"),f.classList.remove("hidden"),hostViewHeading&&hostViewHeading.classList.add("hidden");let e=l.shuffledQuestions[l.currentQuestionIndex];k.textContent=e.question,B(e.shuffledOptions||e.options,[]),P.textContent=`Frage ${l.currentQuestionIndex+1} von `+l.shuffledQuestions.length,v.textContent=l.answersReceived.toString(),S.textContent=getNonHostPlayerCount().toString(),(l.currentQuestionIndex<l.shuffledQuestions.length-1?E:L).classList.remove("hidden")}else b.classList.contains("active")?(h.classList.add("hidden"),u.classList.add("hidden"),f.classList.add("hidden"),b.classList.remove("hidden"),hostViewHeading&&hostViewHeading.classList.remove("hidden"),F()):(h.classList.add("hidden"),u.classList.remove("hidden"),hostViewHeading&&hostViewHeading.classList.remove("hidden"),R(H(hostRoomId)),g.textContent=l.roomId||"N/A");else h.classList.remove("hidden"),u.classList.add("hidden"),f.classList.add("hidden"),b.classList.add("hidden"),hostViewHeading&&hostViewHeading.classList.remove("hidden");function M(){if(o.innerHTML="",0===l.questions.length)return o.innerHTML="<p>Noch keine Fragen hinzugefügt</p>",c.classList.add("hidden");l.questions.forEach((e,t)=>{var n=document.createElement("div"),s=(n.className="question-item",e.correct.map(e=>e+1).join(", "));n.innerHTML=`
                        <p><strong>F${t+1}:</strong> ${sanitizeHTML(e.question)}</p>
                        <p><strong>Optionen:</strong> ${e.options.map(e=>sanitizeHTML(e)).join("; ")}</p>
                        <p><strong>Richtige Option(en):</strong> ${s}</p>
                        <button class="btn remove-question" data-index="${t}">Entfernen</button>
                    `,o.appendChild(n)}),document.querySelectorAll(".remove-question").forEach(e=>{e.onclick=e=>{e=parseInt(e.target.getAttribute("data-index"));l.questions.splice(e,1),M()}}),c.classList.remove("hidden")}function T(e){switch(e.type){case"room_created":hostRoomId=e.roomId,hostSessionId=e.sessionId,l.roomId=e.roomId.substring(0,2)+" "+e.roomId.substring(2,4),h.classList.add("hidden"),u.classList.remove("hidden"),g.textContent=l.roomId,R(H(hostRoomId)),hostViewHeading&&hostViewHeading.classList.remove("hidden"),saveActiveSession("host",hostRoomId,hostSessionId);break;case"host_reconnected":console.log("Host reconnected, restoring player state"),e.players&&e.players.forEach(e=>{l.players[e.sessionId]?(l.players[e.sessionId].isConnected=e.isConnected,l.players[e.sessionId].score=e.score):l.players[e.sessionId]={id:e.sessionId,name:e.name,score:e.score,currentAnswer:[],answerTime:null,isConnected:e.isConnected}}),A(),l.isQuestionActive?(console.log("Restarting active question after reconnect"),N()):hostPendingQuestion&&(console.log("Resending pending question after reconnect"),hostWs)&&hostWs.readyState===WebSocket.OPEN&&(hostWs.send(JSON.stringify(hostPendingQuestion)),hostPendingQuestion=null);break;case"player_joined":var t=sanitizePlayerName(e.name)||"Spieler "+e.sessionId.substring(0,4);l.players[e.sessionId]={id:e.sessionId,name:t,score:0,currentAnswer:[],answerTime:null,isConnected:!0},A();break;case"player_left":l.players[e.sessionId]&&(l.players[e.sessionId].isConnected=!1,A(),l.isQuestionActive)&&l.answersReceived>=getNonHostPlayerCount()&&x();break;case"player_reconnected":t=sanitizePlayerName(e.name)||"Spieler "+e.sessionId.substring(0,4);l.players[e.sessionId]?(l.players[e.sessionId].isConnected=!0,l.players[e.sessionId].score=e.score,l.players[e.sessionId].name=t):l.players[e.sessionId]={id:e.sessionId,name:t,score:e.score,currentAnswer:[],answerTime:null,isConnected:!0},A();break;case"player_answered":s=(t=e).sessionId,l.players[s]&&l.isQuestionActive&&((s=l.players[s]).currentAnswer&&0<s.currentAnswer.length||(l.answersReceived++,n=null!=t.elapsedMs?t.elapsedMs/1e3:(Date.now()-hostQuestionStartTime)/1e3,s.answerTime=n,s.currentAnswer=t.answerData,v.textContent=l.answersReceived.toString(),l.answersReceived>=getNonHostPlayerCount()&&x()));break;case"error":showMessage(e.message,"error")}var n,s}function W(){let n=new WebSocket(WS_URL);n.onopen=()=>{console.log("Host WebSocket reconnected"),hostWsReconnectAttempts=0,n.send(JSON.stringify({type:"reconnect_host",roomId:hostRoomId,sessionId:hostSessionId}))},n.onmessage=e=>{let t;try{t=JSON.parse(e.data)}catch{return}if("room_not_found_try_restore"===t.type){console.log("Room needs restoration. Sending state...");let t=[];if(hostGlobalQuizState&&hostGlobalQuizState.players)for(let e of Object.values(hostGlobalQuizState.players))t.push({id:e.id,name:e.name,score:e.score});void n.send(JSON.stringify({type:"restore_room",roomId:hostRoomId,sessionId:hostSessionId,players:t}))}else T(t)},n.onclose=()=>{console.log("Host WebSocket closed"),hostRoomId&&hostWsReconnectAttempts<HOST_MAX_RECONNECT_ATTEMPTS?(hostWsReconnectAttempts++,setTimeout(W,RECONNECT_DELAY_MS)):hostWsReconnectAttempts>=HOST_MAX_RECONNECT_ATTEMPTS&&showMessage("Verbindung zum Server verloren. Bitte lade die Seite neu.","error")},n.onerror=e=>{console.error("Host WebSocket error:",e)},hostWs=n}function A(){var e=getNonHostPlayers(),t=getConnectedNonHostPlayers().length;O.textContent=t.toString(),S.textContent=t.toString(),I.innerHTML="",e.forEach(e=>{var t=document.createElement("div");!(t.className="player-item")===e.isConnected&&t.classList.add("disconnected"),t.textContent=e.name+(!1===e.isConnected?" (getrennt)":""),I.appendChild(t)}),Q.classList.toggle("hidden",0===t)}function R(t){if(m.innerHTML="","undefined"==typeof QRCode)return console.error("QR-Code-Bibliothek nicht geladen."),m.innerHTML=`<p class="qr-error">QR-Code-Bibliothek nicht geladen. URL: ${sanitizeHTML(t)}</p>`;try{new QRCode(m,{text:t,width:240,height:240,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H})}catch(e){console.error("QR Code generation error:",e),m.innerHTML=`<p class="qr-error">Fehler beim Generieren des QR-Codes. URL: ${sanitizeHTML(t)}</p>`}}function H(e){var e=window.location.origin+window.location.pathname.split("?")[0]+"?host="+e,t=(y.href=e,"bycs.link/karten");return y.textContent=t,p.href=e,p.textContent=t,e}async function N(){if(l.currentQuestionIndex>=l.shuffledQuestions.length)D();else{let e=l.shuffledQuestions[l.currentQuestionIndex],n=(l.answersReceived=0,l.isQuestionActive=!0,hostQuestionStartTime=Date.now(),e.options.map((e,t)=>({text:e,originalIndex:t})));shuffleArray(n);var t=n.map(e=>e.text),s=e.correct.map(t=>n.findIndex(e=>e.originalIndex===t));e.shuffledOptions=t,e.shuffledCorrect=s;for(let e of Object.values(l.players))e.currentAnswer=[],e.answerTime=null;k.textContent=e.question,B(t,[]),P.textContent=`Frage ${l.currentQuestionIndex+1} von `+l.shuffledQuestions.length,v.textContent="0",S.textContent=getNonHostPlayerCount().toString(),E.classList.add("hidden"),L.classList.add("hidden"),V.classList.add("hidden"),hostViewHeading&&hostViewHeading.classList.add("hidden");{s=l.questionDurations[l.currentQuestionIndex];z.style.width="100%",hostTimerInterval&&clearInterval(hostTimerInterval);let t=1e3*s,n=Date.now();hostTimerInterval=setInterval(()=>{var e=Date.now()-n,e=Math.max(0,t-e);z.style.width=e/t*100+"%",e<=0&&(clearInterval(hostTimerInterval),hostTimerInterval=null,setTimeout(()=>x(),2e3))},100)}(async e=>{e={type:"start_question",question:e.question,options:e.shuffledOptions,index:l.currentQuestionIndex,total:l.shuffledQuestions.length,startTime:hostQuestionStartTime,duration:l.questionDurations[l.currentQuestionIndex]},hostWs&&hostWs.readyState===WebSocket.OPEN?(hostPendingQuestion=null,hostWs.send(JSON.stringify(e))):(showMessage("Keine Verbindung zum Server. Frage wird nach Reconnect gesendet.","error"),hostPendingQuestion=e)})(e)}}function B(e,t=[],o=[]){_.innerHTML="";let r=new Set(t);e.forEach((e,t)=>{var n=document.createElement("li");let s=e;o&&void 0!==o[t]&&(s+=` (${o[t]}x gewählt)`),n.textContent=s,r.has(t)&&n.classList.add("correct"),_.appendChild(n)})}async function x(){if(l.isQuestionActive){hostTimerInterval&&(clearInterval(hostTimerInterval),hostTimerInterval=null),l.isQuestionActive=!1;let e=l.shuffledQuestions[l.currentQuestionIndex],t=Array(e.shuffledOptions.length).fill(0);getNonHostPlayers().forEach(e=>{e.currentAnswer&&Array.isArray(e.currentAnswer)&&e.currentAnswer.forEach(e=>{void 0!==t[e]&&t[e]++})}),B(e.shuffledOptions,e.shuffledCorrect,t);{let e=l.shuffledQuestions[l.currentQuestionIndex],o=new Set(e.shuffledCorrect),r=l.questionDurations[l.currentQuestionIndex],t=l.shuffledQuestions.length,i=e.shuffledOptions.length-o.size,a=100;if(1<t){let e=200/(t-1);a=100+l.currentQuestionIndex*e}getNonHostPlayers().forEach(t=>{if(t.currentAnswer&&0<t.currentAnswer.length){var n=new Set(t.currentAnswer),s=[...n].filter(e=>o.has(e)).length,n=[...n].filter(e=>!o.has(e)).length,s=s/o.size,n=0<i?n/i:0,s=Math.max(0,s-n);if(0<s){n=null!==t.answerTime?t.answerTime:r,n=Math.max(0,Math.min(n,r));let e=Math.max(0,r-n)/r*(.5*a);t.score+=s*(a+e)}}})}if(hostWs&&hostWs.readyState===WebSocket.OPEN){let e=l.shuffledQuestions[l.currentQuestionIndex],t=l.currentQuestionIndex===l.shuffledQuestions.length-1,n=t?q():null,s={};getNonHostPlayers().forEach(e=>{s[e.id]=e.score}),hostWs.send(JSON.stringify({type:"send_results",correct:e.shuffledCorrect,isFinal:t,leaderboard:n,playerScores:s}))}var n;await 0,n=q(),w.innerHTML="",V.classList.remove("hidden"),0===(n=n.slice(0,10)).length?w.innerHTML="<li>Noch keine Spieler.</li>":n.forEach((e,t)=>{var n=document.createElement("li");n.className="scoreboard-item",0===t?n.classList.add("rank-1"):1===t?n.classList.add("rank-2"):2===t&&n.classList.add("rank-3"),n.innerHTML=`<span>${t+1}. ${sanitizeHTML(e.name)}</span><span>${Math.round(e.score)} Punkte</span>`,w.appendChild(n)}),l.currentQuestionIndex<l.shuffledQuestions.length-1?(E.classList.remove("hidden"),L.classList.add("hidden")):(E.classList.add("hidden"),L.classList.remove("hidden"))}}function D(){f.classList.add("hidden"),b.classList.remove("hidden"),hostViewHeading&&hostViewHeading.classList.remove("hidden"),F()}function q(){return getNonHostPlayers().map(e=>({name:e.name,score:e.score})).sort((e,t)=>t.score-e.score)}function F(){var e=q();C.innerHTML="",0!==e.length?e.forEach((e,t)=>{var n=document.createElement("div");n.className="leaderboard-item",0===t?n.classList.add("rank-1"):1===t?n.classList.add("rank-2"):2===t&&n.classList.add("rank-3"),n.innerHTML=`<span>${t+1}. ${sanitizeHTML(e.name)}</span><span>${Math.round(e.score)} Punkte</span>`,C.appendChild(n)}):C.innerHTML="<p>Noch keine Spieler in der Rangliste.</p>"}e&&e.roomId&&e.sessionId&&(async e=>{hostWsReconnectAttempts=0,hostRoomId=e.roomId,hostSessionId=e.sessionId,l.roomId=e.roomId.substring(0,2)+" "+e.roomId.substring(2,4);try{hostWs=await connectWithRetry(WS_URL)}catch(e){return showMessage("Server nicht erreichbar. Bitte versuche es später erneut.","error"),clearActiveSession(),hostRoomId=null,hostSessionId=null,document.getElementById("role-selection").classList.remove("hidden"),!showView("role-selection")}hostWs.send(JSON.stringify({type:"reconnect_host",roomId:hostRoomId,sessionId:hostSessionId})),hostWs.onmessage=e=>{let t;try{t=JSON.parse(e.data)}catch{return}"room_not_found_try_restore"===t.type?(showMessage("Der Raum ist abgelaufen. Bitte starte ein neues Quiz.","error"),clearActiveSession(),hostRoomId=null,hostSessionId=null,document.getElementById("role-selection").classList.remove("hidden"),showView("role-selection")):"error"===t.type?(showMessage(t.message,"error"),clearActiveSession(),hostRoomId=null,hostSessionId=null,document.getElementById("role-selection").classList.remove("hidden"),showView("role-selection")):("host_reconnected"===t.type&&(h.classList.add("hidden"),u.classList.remove("hidden"),g.textContent=l.roomId,R(H(hostRoomId)),hostViewHeading)&&hostViewHeading.classList.remove("hidden"),T(t))},hostWs.onclose=()=>{console.log("Host WebSocket closed"),hostRoomId&&hostWsReconnectAttempts<HOST_MAX_RECONNECT_ATTEMPTS?(hostWsReconnectAttempts++,setTimeout(W,RECONNECT_DELAY_MS)):hostWsReconnectAttempts>=HOST_MAX_RECONNECT_ATTEMPTS&&showMessage("Verbindung zum Server verloren. Bitte lade die Seite neu.","error")},hostWs.onerror=e=>{console.error("Host WebSocket error:",e)}})(e)}let playerWs=null,playerRoomId=null,playerCurrentId=null,isPlayerInitialized=!1,playerTimerInterval=null,playerCurrentQuestionOptions=[],selectedAnswers=[],playerScore=0,playerQuestionStartTime=null,playerCurrentQuestionIndex=-1,playerBeforeUnloadHandler=null;function reconnectPlayerWs(){var e=playerWs?playerWs.onmessage:null,t=playerWs?playerWs.onclose:null,n=playerWs?playerWs.onerror:null;playerWs&&(playerWs.onclose=null,playerWs.close());let s=getPlayerSession(playerRoomId),o=s?s.playerName:"Spieler",r=new WebSocket(WS_URL);r.onopen=()=>{r.send(JSON.stringify({type:"join",roomCode:playerRoomId,playerName:o,sessionId:playerCurrentId}))},r.onmessage=e,r.onclose=t,r.onerror=n,playerWs=r}function getPlayerStorageKey(e){return"quiz_player_"+e}function savePlayerSession(e,t,n){t={playerId:t,playerName:n,timestamp:Date.now()};localStorage.setItem(getPlayerStorageKey(e),JSON.stringify(t))}function getPlayerSession(e){var t=getPlayerStorageKey(e),n=localStorage.getItem(t);if(!n)return null;try{let e=JSON.parse(n);return 864e5<Date.now()-e.timestamp?(localStorage.removeItem(t),null):e}catch(e){return localStorage.removeItem(t),null}}function clearPlayerSession(e){localStorage.removeItem(getPlayerStorageKey(e))}let ACTIVE_SESSION_KEY="quiz_active_session";function saveActiveSession(e,t,n,s){localStorage.setItem(ACTIVE_SESSION_KEY,JSON.stringify({role:e,roomId:t,sessionId:n,playerName:s||null,timestamp:Date.now()}))}function getActiveSession(){var e=localStorage.getItem(ACTIVE_SESSION_KEY);if(!e)return null;try{var t=JSON.parse(e);return 72e5<Date.now()-t.timestamp?(localStorage.removeItem(ACTIVE_SESSION_KEY),null):t}catch{return localStorage.removeItem(ACTIVE_SESSION_KEY),null}}function clearActiveSession(){localStorage.removeItem(ACTIVE_SESSION_KEY);var e=document.getElementById("reconnect-host-btn"),t=document.getElementById("reconnect-player-btn");e&&e.classList.add("hidden"),t&&t.classList.add("hidden")}function triggerConfetti(){var t=document.getElementById("confetti-container");if(t){var n=["#f44336","#e91e63","#9c27b0","#673ab7","#3f51b5","#2196f3","#03a9f4","#00bcd4","#009688","#4CAF50","#8bc34a","#cddc39","#ffeb3b","#ffc107","#ff9800","#ff5722"];for(let e=0;e<50;e++){let e=document.createElement("div");e.className="confetti-piece",e.style.left=100*Math.random()+"vw",e.style.top=-20-100*Math.random()+"px",e.style.backgroundColor=n[Math.floor(Math.random()*n.length)],e.style.animationDelay=.5*Math.random()+"s",e.style.animationDuration=2+2*Math.random()+"s",t.appendChild(e),e.addEventListener("animationend",()=>{e.remove()})}}else console.warn("Confetti-Container nicht gefunden.")}function initializePlayerFeatures(t){let n=document.getElementById("room-code-input"),s=document.getElementById("player-name-input"),e=document.getElementById("join-btn"),i=document.getElementById("join-form"),m=document.getElementById("waiting-room"),g=document.getElementById("waiting-message"),y=document.getElementById("player-question"),p=document.getElementById("player-question-text"),I=document.getElementById("player-question-counter"),f=document.getElementById("player-timer-bar"),v=document.getElementById("options-container"),S=document.getElementById("submit-answer-btn"),w=document.getElementById("player-result"),E=document.getElementById("result-display"),L=document.getElementById("player-score"),b=document.getElementById("waiting-for-next"),C=document.getElementById("player-final-result"),M=document.getElementById("final-score"),o=document.getElementById("play-again-btn"),T=document.getElementById("player-leaderboard-container");if(isPlayerInitialized||(e.addEventListener("click",async()=>{var e=n.value.trim().replace(/\s/g,""),t=s.value.trim()||"Spieler "+generateAlphanumericId(4);e?r(e,t):showMessage("Bitte gib einen Raum-Code ein.","error")}),S.addEventListener("click",async()=>{0!==selectedAnswers.length?(S.disabled=!0,v.querySelectorAll("button.option-btn").forEach(e=>e.disabled=!0),playerTimerInterval&&(clearInterval(playerTimerInterval),playerTimerInterval=null),playerWs&&playerWs.readyState===WebSocket.OPEN?playerWs.send(JSON.stringify({type:"submit_answer",answerData:selectedAnswers,answerTime:(new Date).toISOString()})):showMessage("Verbindung unterbrochen. Antwort konnte nicht gesendet werden.","error")):showMessage("Bitte wähle mindestens eine Antwort aus.","info")}),o.addEventListener("click",()=>{W(),isPlayerInitialized=!1,showView("role-selection")}),playerBeforeUnloadHandler&&window.removeEventListener("beforeunload",playerBeforeUnloadHandler),playerBeforeUnloadHandler=()=>{playerWs&&playerWs.close()},window.addEventListener("beforeunload",playerBeforeUnloadHandler),isPlayerInitialized=!0),n.value="",s.value="",i.classList.remove("hidden"),m.classList.add("hidden"),y.classList.add("hidden"),w.classList.add("hidden"),C.classList.add("hidden"),t&&t.roomId&&t.sessionId){playerCurrentId=t.sessionId;let e=t.playerName||"Spieler";r(t.roomId,e)}async function r(n,s){playerRoomId=n;let o=0,e=(i.classList.add("hidden"),m.classList.remove("hidden"),g.textContent=`Verbinde mit Raum ${playerRoomId}...`,getPlayerSession(playerRoomId)),r=e?e.playerId:null;!function t(){connectWithRetry(WS_URL).then(e=>{playerWs=e,console.log("Player WebSocket connected"),o=0,playerWs.send(JSON.stringify({type:"join",roomCode:n,playerName:s,sessionId:r||playerCurrentId})),playerWs.onmessage=e=>{let a;try{a=JSON.parse(e.data)}catch{return}switch(a.type){case"joined":playerCurrentId=a.sessionId,playerScore=a.score||0,savePlayerSession(n,a.sessionId,a.playerName||s),saveActiveSession("player",n,a.sessionId,a.playerName||s),g.textContent=a.isReconnect?"Wieder verbunden! Warte auf Host...":"Verbunden! Warte auf Host...";break;case"question":playerCurrentQuestionOptions=a.options,selectedAnswers=[],playerCurrentQuestionIndex=a.index,playerQuestionStartTime=Date.now(),l=a,m.classList.add("hidden"),w.classList.add("hidden"),y.classList.remove("hidden"),p.textContent=l.question,I.textContent=`Frage ${l.index+1} von `+l.total,v.innerHTML="",selectedAnswers=[],l.options.forEach((e,t)=>{let n=document.createElement("button");n.className="option-btn",n.textContent=e,n.dataset.index=t,n.addEventListener("click",()=>{var e=parseInt(n.dataset.index),t=selectedAnswers.indexOf(e);-1<t?(selectedAnswers.splice(t,1),n.classList.remove("selected")):(selectedAnswers.push(e),n.classList.add("selected")),S.classList.toggle("hidden",0===selectedAnswers.length)}),v.appendChild(n)}),S.classList.add("hidden"),S.disabled=!1,v.querySelectorAll("button.option-btn").forEach(e=>{e.disabled=!1,e.classList.remove("correct-answer","incorrect-answer","selected")});{l=a.duration;f.style.width="100%",playerTimerInterval&&clearInterval(playerTimerInterval);let t=1e3*l,n=Date.now();playerTimerInterval=setInterval(()=>{var e=Date.now()-n,e=Math.max(0,t-e);f.style.width=e/t*100+"%",e<=0&&(clearInterval(playerTimerInterval),playerTimerInterval=null,S.disabled||(S.disabled=!0,playerWs&&playerWs.readyState===WebSocket.OPEN?playerWs.send(JSON.stringify({type:"submit_answer",answerData:selectedAnswers,answerTime:(new Date).toISOString()})):showMessage("Verbindung unterbrochen. Antwort konnte nicht gesendet werden.","error")),S.classList.add("hidden"),v.querySelectorAll("button.option-btn").forEach(e=>e.disabled=!0))},100)}break;case"result":{if(void 0!==a.questionIndex&&a.questionIndex!==playerCurrentQuestionIndex){console.log(`Ignoring stale result for question ${a.questionIndex}, current is `+playerCurrentQuestionIndex);break}let i=playerScore;playerScore=a.playerScore||playerScore;{var[l,d,c,u,h=0]=[a,selectedAnswers,playerScore,playerScore-i,i];y.classList.add("hidden"),w.classList.remove("hidden");let n="Deine Antwort war ",s=new Set(d||[]),o=new Set(l.correct),e=playerCurrentQuestionOptions,t=[...s].filter(e=>o.has(e)).length,r=t===o.size&&s.size===o.size;d&&0!==d.length?r?(n+='<strong class="correct">RICHTIG!</strong> ',triggerConfetti()):n+=0<t?`<strong class="correct">TEILWEISE RICHTIG (${t}/${o.size})</strong> `:'<strong class="incorrect">FALSCH.</strong> ':n="Du hast nicht geantwortet. ",n+="<br>Richtige Antwort(en): ",e.forEach((e,t)=>{o.has(t)?s.has(t)?n+=`<span class="correct player-selected">"${sanitizeHTML(e)}"</span> `:n+=`<span class="correct-not-selected">"${sanitizeHTML(e)}"</span> `:s.has(t)}),E.innerHTML=n,0<u?L.innerHTML=`${Math.round(h)} + <span class="score-gained">${Math.round(u)}</span> = <strong>${Math.round(c)}</strong>`:L.textContent=Math.round(c),v.querySelectorAll("button.option-btn").forEach(e=>{var t=parseInt(e.dataset.index);e.disabled=!0,e.classList.remove("selected"),o.has(t)&&e.classList.add("correct-answer"),s.has(t)&&o.has(t)&&e.classList.add("selected")})}if(b.textContent=a.isFinal?"Warten auf Endergebnisse...":"Warten auf nächste Frage...",a.isFinal){d=a;if(y.classList.add("hidden"),w.classList.add("hidden"),m.classList.add("hidden"),C.classList.remove("hidden"),M.textContent=Math.round(playerScore),T.innerHTML="",d.leaderboard){h=document.createElement("div");h.innerHTML="<h4>Endgültige Rangliste:</h4>";let s=document.createElement("ol");0===d.leaderboard.length?s.innerHTML="<li>Keine Spieler in der Rangliste.</li>":d.leaderboard.forEach((e,t)=>{var n=document.createElement("li");0===t?n.classList.add("rank-1"):1===t?n.classList.add("rank-2"):2===t&&n.classList.add("rank-3"),n.textContent=`${t+1}. ${e.name}: ${Math.round(e.score)} Punkte`,s.appendChild(n)}),h.appendChild(s),T.appendChild(h)}else T.innerHTML="<p>Keine Ranglistendaten verfügbar.</p>"}break}case"quiz_terminated":showMessage("Der Host hat das Quiz beendet.","info"),W(),showView("role-selection");break;case"error":showMessage(a.message,"error"),W(),document.getElementById("role-selection").classList.remove("hidden"),showView("role-selection")}},playerWs.onclose=()=>{console.log("Player WebSocket closed"),playerRoomId&&playerCurrentId&&o<30?(o++,g.textContent=`Verbindung unterbrochen. Reconnect ${o}/30...`,setTimeout(t,RECONNECT_DELAY_MS)):30<=o&&(showMessage("Verbindung zum Quiz-Raum verloren. Bitte lade die Seite neu.","error"),W())},playerWs.onerror=e=>{console.error("Player WebSocket error:",e)}}).catch(()=>{showMessage("Server nicht erreichbar. Bitte versuche es später erneut.","error"),W(),document.getElementById("role-selection").classList.remove("hidden"),showView("role-selection")})}()}function W(){clearActiveSession(),playerWs&&(playerWs.onclose=null,playerWs.close(),playerWs=null),playerScore=0,selectedAnswers=[],playerCurrentQuestionOptions=[],playerQuestionStartTime=null,playerCurrentQuestionIndex=-1,playerRoomId=null,playerCurrentId=null,n.value="",s.value="",i.classList.remove("hidden"),m.classList.add("hidden"),y.classList.add("hidden"),w.classList.add("hidden"),C.classList.add("hidden"),v.innerHTML="",E.innerHTML="",T.innerHTML="",L.textContent="0",M.textContent="0"}}</script></body></html>