<!doctype html><html lang="de"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; connect-src 'self' https://*.supabase.co wss://*.supabase.co; img-src 'self' data:; font-src 'self'; base-uri 'self'; form-action 'self';"><meta name="referrer" content="no-referrer"><title>Multiplayer Quiz</title><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script><script>function sanitizeHTML(t){var e;return"string"!=typeof t?"":((e=document.createElement("div")).textContent=t,e.innerHTML)}function sanitizeInput(t,e=1e3){if("string"!=typeof t)return"";let n=t.trim();return n=(n=n.length>e?n.substring(0,e):n).replace(/\0/g,"")}function sanitizePlayerName(t){if("string"!=typeof t)return"";let e=sanitizeHTML(t);return e=(e=sanitizeInput(e,50)).replace(/[^a-zA-Z0-9äöüÄÖÜß\s\-_\.]/g,"")}function sanitizeRoomCode(t){return"string"!=typeof t?"":t.toUpperCase().replace(/[^A-Z0-9]/g,"").substring(0,10)}function sanitizeQuestionText(t){return"string"!=typeof t?"":sanitizeInput(sanitizeHTML(t),5e3)}function sanitizeJSON(t,e=5242880){if("string"!=typeof t)return null;if(new Blob([t]).size>e)return console.error("JSON file too large"),null;try{return JSON.parse(t)}catch(t){return console.error("Invalid JSON:",t),null}}function sanitizeURL(t){if("string"==typeof t)try{var e=new URL(t);if("http:"===e.protocol||"https:"===e.protocol)return t}catch(t){}return""}function createSafeTextNode(t){return document.createTextNode(sanitizeInput(t))}function setSafeText(t,e){t&&"string"==typeof e&&(t.textContent=sanitizeInput(e))}function isValidEmail(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)}</script><style>@keyframes confetti-fall{0%{transform:translateY(-100px) rotateZ(0);opacity:0}10%{opacity:1}to{transform:translateY(100vh) rotateZ(720deg);opacity:0}}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}:root{--primary-color:#46178f;--secondary-color:#5e22b2;--accent-color:#ff3355;--light-color:#f7f7f7;--dark-color:#333;--correct-color:#00c853;--wrong-color:#ff3d00}*{margin:0;padding:0;box-sizing:border-box;font-family:Montserrat,Arial,sans-serif}body{background-color:var(--light-color);color:var(--dark-color);font-size:18px}h1{font-size:2rem}h2{font-size:1.7em}h3{font-size:1.5em}.container{max-width:1200px;margin:0 auto;padding:20px}header{color:#fff;padding:1rem;text-align:center;border-radius:8px;margin-bottom:2rem}.view{display:none}.active{display:block}.btn,input,select{margin:10px 0;border-radius:4px}.btn{background-color:var(--secondary-color);color:#fff;border:0;padding:12px 20px;cursor:pointer;font-size:1.1em;transition:background-color .3s}.btn:hover,header{background-color:var(--primary-color)}.btn-accent{background-color:var(--accent-color)}.btn-accent:hover{background-color:#e62b4c}.card{background-color:#fff;border-radius:8px;padding:20px;box-shadow:0 4px 6px rgba(0,0,0,.1);margin-bottom:20px}input,select{width:100%;padding:12px;border:1px solid #ddd;font-size:1em}#question-form,#questions-list{margin-top:20px}.option-group{display:flex;flex-wrap:wrap;align-items:center;margin-bottom:10px}.option-group input[type=text]{flex-grow:1;margin-right:10px;min-width:150px}.option-group input[type=checkbox]{width:auto;margin-left:10px}.option-group label{margin-left:5px}.option-btn,.question-item{background-color:#f1f1f1;padding:15px;border-radius:4px;margin-bottom:10px}.option-btn{display:block;width:100%;margin-bottom:8px;border:1px solid #ddd;border-radius:8px;background-color:#f0f0f0;text-align:left;cursor:pointer;transition:background-color .2s ease;font-size:1.1em}.option-btn:hover:not(:disabled){background-color:#e9e9e9}.option-btn.selected{background-color:var(--secondary-color);color:#fff;border-color:var(--secondary-color)}.option-btn.correct,.option-btn.correct-answer{background-color:var(--correct-color);color:#fff;border-color:var(--correct-color);font-weight:700}.option-btn.incorrect,.option-btn.incorrect-answer.selected{background-color:var(--wrong-color);color:#fff;border-color:var(--wrong-color);font-weight:700}.host-options-list{margin-top:15px;padding:0;list-style:none}.host-options-list li{background-color:#f0f0f0;border:1px solid #ddd;padding:10px;margin-bottom:8px;border-radius:8px;font-size:1.1em}.host-options-list li.correct{background-color:#d4edda;border-color:#c3e6cb;font-weight:700}#result-display{text-align:center;font-size:1.5rem;margin:20px 0;padding:15px;border-radius:8px}#result-display.correct{background-color:rgba(0,200,83,.2);color:var(--correct-color)}#result-display.incorrect{background-color:rgba(255,61,0,.2);color:var(--wrong-color)}.result-display .correct{color:var(--correct-color);font-weight:700}.result-display .incorrect{color:var(--wrong-color);font-weight:700}.result-display .player-selected{text-decoration:underline;font-weight:700}.result-display .correct-not-selected{font-weight:700;font-style:italic;color:var(--correct-color)}.scoreboard{margin-top:25px;padding-top:20px;border-top:1px solid #eee}.scoreboard h4{margin-bottom:15px;font-size:1.4em}.scoreboard ol{padding-left:25px}.scoreboard li{margin-bottom:8px;font-size:1.2em}.scoreboard-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #eee}.scoreboard-item:last-child{border-bottom:none}#large-qrcode,.qr-modal-overlay{display:flex;justify-content:center;align-items:center}.qr-modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1000}.qr-modal-content{background:#fff;padding:30px;border-radius:12px;position:relative;text-align:center;box-shadow:0 8px 16px rgba(0,0,0,.3);max-width:90%}.qr-modal-close{position:absolute;top:15px;right:15px;background:0 0;border:0;font-size:2.2em;cursor:pointer;color:#333;line-height:1}.qr-modal-close:hover{color:#000}#large-qrcode{margin:30px auto}#large-qrcode img{width:300px;max-width:100%;height:auto}#qrcode{margin:20px auto;text-align:center}.leaderboard-item.rank-1,.scoreboard-item.rank-1{background-color:#ffeb3b;font-weight:700;border-color:#fbc02d}.leaderboard-item.rank-2,.scoreboard-item.rank-2{background-color:#e0e0e0;font-weight:700;border-color:#bdbdbd}.leaderboard-item.rank-3,.scoreboard-item.rank-3{background-color:#ffccbc;font-weight:700;border-color:#e64a19}.hidden{display:none!important}#confetti-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden;z-index:999}.confetti-piece{position:absolute;width:10px;height:10px;background-color:var(--confetti-color);opacity:0;animation:confetti-fall 3s ease-out forwards}#leaderboard{margin-top:20px}.leaderboard-item{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #ddd}.leaderboard-item:last-child{border-bottom:none}.loader{border:5px solid #f3f3f3;border-top:5px solid var(--secondary-color);border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:20px auto}.timer-bar{height:10px;background-color:var(--accent-color);width:100%;border-radius:5px;margin-top:10px;transition:width 1s linear}.players-list{margin:20px 0}.player-item{background-color:#f1f1f1;padding:10px;border-radius:4px;margin-bottom:5px}.flex-row{display:flex;gap:10px}.correct-answers{margin-top:10px;color:var(--correct-color);font-weight:700}.score-display{font-size:1.2rem;font-weight:700;text-align:center;margin:15px 0}.question-counter{text-align:center;margin-bottom:15px;color:var(--secondary-color)}.file-input-container{position:relative;overflow:hidden;display:inline-block}.file-input-container input[type=file]{position:absolute;font-size:100px;right:0;top:0;opacity:0;cursor:pointer}.file-input-label{display:inline-block;padding:10px 20px;background-color:var(--secondary-color);color:#fff;border-radius:4px;cursor:pointer}@media (max-width:600px){body{font-size:16px}h1{font-size:2em}h2{font-size:1.6em}h3{font-size:1.3em}.container{padding:15px}.card{padding:20px}input[type=number],input[type=text]{padding:12px;font-size:1em}.btn{padding:12px 20px;font-size:1.1em}.option-btn{padding:12px}.host-options-list li{padding:8px;font-size:1em}.scoreboard h4{font-size:1.2em}.option-btn,.scoreboard li{font-size:1em}.qr-modal-content{padding:20px}#large-qrcode img{width:250px;height:250px}}.player-item.disconnected{opacity:.5;font-style:italic}</style></head><body><div class="container"><header><h1>Multiplayer Quiz</h1></header><div id="role-selection" class="view active card"><h2>Wähle deine Rolle</h2><button id="host-btn" class="btn">Quiz hosten</button> <button id="player-btn" class="btn">Quiz beitreten</button></div><div id="host-view" class="view card"><h2 id="host-view-heading">Quiz hosten</h2><div id="host-setup"><div class="duration-setting" style="margin-top:15px"><label for="question-duration-input">Fragedauer (Sekunden):</label> <input type="number" id="question-duration-input" value="20" min="5" max="60" class="w-full p-2 border rounded"></div><button id="start-quiz-btn" class="btn btn-accent" style="margin-top:10px">Quiz starten</button><div class="file-input-container"><label for="json-file" class="file-input-label">Fragen importieren (JSON)</label> <input type="file" id="json-file" accept=".json"></div><p id="file-status"></p><h3>Oder Fragen manuell erstellen:</h3><form id="question-form"><div><label for="question-text">Frage:</label> <input id="question-text" placeholder="Gib deine Frage ein"></div><div class="option-group"><input class="option-input" placeholder="Option 1"> <input type="checkbox" class="correct-checkbox"> <label>Richtig</label></div><div class="option-group"><input class="option-input" placeholder="Option 2"> <input type="checkbox" class="correct-checkbox"> <label>Richtig</label></div><button type="button" id="add-option-btn" class="btn">Option hinzufügen</button> <button type="submit" class="btn">Frage hinzufügen</button></form><div id="questions-list"><h3>Hinzugefügte Fragen:</h3><div id="questions-container"><p>Noch keine Fragen hinzugefügt</p></div></div></div><div id="qr-container" class="hidden"><h3>Diesen Link oder QR-Code teilen, damit Spieler beitreten kÃ¶nnen:</h3><div id="qrcode" style="cursor:pointer"></div><p>Beitrittslink: <a id="join-link" href="#" target="_blank"></a></p><p>Raum-Code: <span id="room-id"></span></p><p>Verbundene Spieler: <span id="player-count">0</span></p><div class="players-list" id="players-list"></div><button id="start-questions-btn" class="btn btn-accent hidden">Fragen starten</button></div><div id="host-question-display" class="hidden"><h3 id="current-question-text"></h3><ul id="host-current-options" class="host-options-list"></ul><div class="question-counter" id="question-counter"></div><div class="timer-bar-container"><div class="timer-bar" id="timer-bar"></div></div><p>Spieler haben geantwortet: <span id="answers-count">0</span>/<span id="total-players">0</span></p><div id="host-scoreboard" class="scoreboard hidden"><h4>Aktuelle Rangliste (Top 10)</h4><ol id="scoreboard-list"></ol></div><button id="show-next-btn" class="btn hidden">Nächste Frage</button> <button id="show-results-btn" class="btn hidden">Endergebnisse anzeigen</button></div><div id="host-results" class="view card hidden"><h3>Endgültige Rangliste</h3><div id="leaderboard"></div><button id="new-quiz-btn" class="btn">Neues Quiz hosten</button></div></div><div id="player-view" class="view card"><div id="join-form"><h2>Einem Quiz beitreten</h2><input id="room-code-input" placeholder="Host-ID eingeben oder QR scannen"> <input id="player-name-input" placeholder="Dein Name"> <button id="join-btn" class="btn">Quiz beitreten</button><p>Oder scanne den vom Host bereitgestellten QR-Code</p></div><div id="waiting-room" class="hidden"><h2>Warten auf den Quizstart</h2><p id="waiting-message">Du bist dem Raum erfolgreich beigetreten!</p><div class="loader"></div><p>Der Host wird das Quiz bald starten...</p></div><div id="player-question" class="hidden"><h3 id="player-question-text"></h3><div class="question-counter" id="player-question-counter"></div><div class="timer-bar-container"><div class="timer-bar" id="player-timer-bar"></div></div><div id="options-container"></div><button id="submit-answer-btn" class="btn hidden">Antwort absenden</button></div><div id="player-result" class="hidden"><div id="result-display"></div><div class="score-display">Deine Punktzahl: <span id="player-score">0</span></div><p id="waiting-for-next">Warten auf nächste Frage...</p></div><div id="player-final-result" class="view card hidden"><h2>Quiz beendet!</h2><div id="player-leaderboard-container" style="margin-bottom:15px"></div><div class="score-display">Deine Endpunktzahl: <span id="final-score">0</span></div><p>Vielen Dank fürs Mitspielen!</p><button id="play-again-btn" class="btn">Nochmal spielen</button></div></div></div><div id="qr-modal-overlay" class="qr-modal-overlay hidden"><div id="qr-modal-content" class="qr-modal-content"><button id="qr-modal-close" class="qr-modal-close">&times;</button><h3>Zum Beitreten scannen</h3><div id="large-qrcode"></div><p>Beitrittslink: <a id="join-link-modal" href="#" target="_blank"></a></p><p>Raum-Code: <span id="modal-room-id"></span></p></div></div><div id="confetti-container"></div><footer style="text-align:center;margin-top:20px;font-size:.9em"><p><a href="datenschutz.html" style="color:#000;text-decoration:none">Datenschutzhinweise</a></p></footer><script>let SUPABASE_URL="https://psjanfchvdsefvzxqtac.supabase.co",SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzamFuZmNodmRzZWZ2enhxdGFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5ODYxMjMsImV4cCI6MjA2MzU2MjEyM30._VlPXwOCbwmG0ilFhNIJanPOEyDoOUY16PUyhswyMYY",supabaseClient;function showMessage(e,t="info"){console.log(`Message (${t}): `+e),alert(e)}function showView(e){document.querySelectorAll(".view").forEach(e=>e.classList.remove("active"));var t=document.getElementById(e);t?t.classList.add("active"):console.error("View not found:",e),"host-view"!==e&&"player-view"!==e||document.getElementById("role-selection").classList.add("hidden")}function generateAlphanumericId(t){let n="";for(let e=0;e<t;e++)n+="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(Math.floor(36*Math.random()));return n}function shuffleArray(t){for(let e=t.length-1;0<e;e--){var n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}}let qrModalOverlay=null,qrModalCloseBtn=null,largeQrcodeContainer=null,modalRoomIdSpan=null,hostGlobalQuizState=(document.addEventListener("DOMContentLoaded",()=>{if("undefined"!=typeof supabase&&supabase.createClient){{let e=supabase.createClient;supabaseClient=e(SUPABASE_URL,SUPABASE_ANON_KEY)}qrModalOverlay=document.getElementById("qr-modal-overlay"),qrModalCloseBtn=document.getElementById("qr-modal-close"),largeQrcodeContainer=document.getElementById("large-qrcode"),modalRoomIdSpan=document.getElementById("modal-room-id"),qrModalCloseBtn&&qrModalCloseBtn.addEventListener("click",()=>{qrModalOverlay&&qrModalOverlay.classList.add("hidden")}),qrModalOverlay&&qrModalOverlay.addEventListener("click",e=>{e.target===qrModalOverlay&&qrModalOverlay.classList.add("hidden")}),document.getElementById("host-btn").addEventListener("click",()=>{showView("host-view"),initializeHostFeatures()}),document.getElementById("player-btn").addEventListener("click",()=>{showView("player-view"),initializePlayerFeatures()});let e=new URLSearchParams(window.location.search).get("host");e?(showView("player-view"),initializePlayerFeatures(),document.getElementById("room-code-input").value=e):showView("role-selection")}else console.error("Supabase library not loaded or 'supabase.createClient' is undefined. Please check network and script loading."),showMessage("Fehler: Die Supabase-Bibliothek konnte nicht geladen werden. Bitte überprüfe deine Internetverbindung oder versuche es später erneut.","error")}),null),hostSupabaseChannel=null,hostPlayersSubscription=null,isHostInitialized=!1,hostTimerInterval=null,hostQuestionStartTime=null,hostRoomId=null,hostPlayerId=null,hostViewHeading=null;async function initializeHostFeatures(){console.log("Initializing Host Features. Initialized flag:",isHostInitialized);let i=hostGlobalQuizState=hostGlobalQuizState||{currentQuestionIndex:0,questions:[],shuffledQuestions:[],players:{},answersReceived:0,isQuestionActive:!1,roomId:null,questionDuration:20},e=document.getElementById("json-file"),n=document.getElementById("file-status"),r=document.getElementById("question-form"),o=document.getElementById("question-text"),s=document.getElementById("add-option-btn"),a=document.getElementById("questions-container"),t=document.getElementById("question-duration-input"),l=document.getElementById("start-quiz-btn"),d=document.getElementById("qr-container"),c=document.getElementById("host-setup"),u=document.getElementById("qrcode"),h=document.getElementById("room-id"),m=document.getElementById("join-link"),p=document.getElementById("join-link-modal"),P=document.getElementById("player-count"),y=document.getElementById("players-list"),g=document.getElementById("start-questions-btn"),f=document.getElementById("host-question-display"),w=document.getElementById("current-question-text"),I=document.getElementById("host-current-options"),v=document.getElementById("question-counter"),b=document.getElementById("timer-bar"),C=document.getElementById("answers-count"),L=document.getElementById("total-players"),E=document.getElementById("host-scoreboard"),S=document.getElementById("scoreboard-list"),q=document.getElementById("show-next-btn"),B=document.getElementById("show-results-btn"),x=document.getElementById("host-results"),_=document.getElementById("leaderboard"),z=document.getElementById("new-quiz-btn");if(hostViewHeading=document.getElementById("host-view-heading"),t.value=i.questionDuration,isHostInitialized||(console.log("Setting up host event listeners for the first time."),e.addEventListener("change",e=>{var t,e=e.target.files[0];e&&((t=new FileReader).onload=e=>{try{var t=JSON.parse(e.target.result);t&&Array.isArray(t)&&t.every(e=>e.question&&e.options&&e.correct)?i.questions=t:t&&t.cards&&Array.isArray(t.cards)?i.questions=t.cards:(n.textContent='Ungültiges JSON. Erwartet wird ein Array von Fragen oder eine "Karten"-Struktur.',i.questions=[]),n.textContent=0<i.questions.length?`Importiert ${i.questions.length} Fragen.`:n.textContent||"Keine Fragen im JSON gefunden.",A()}catch(e){console.error("Error parsing JSON:",e),n.textContent="Fehler beim Parsen des JSON. Format überprüfen.",i.questions=[],A()}},t.readAsText(e))}),s.addEventListener("click",()=>{var e=r.querySelectorAll(".option-group").length+1,t=document.createElement("div");t.className="option-group",t.innerHTML=`<input type="text" class="option-input" placeholder="Option ${e}"><input type="checkbox" class="correct-checkbox"><label>Richtig</label></div>`,r.insertBefore(t,s)}),r.addEventListener("submit",t=>{t.preventDefault();t=o.value.trim();if(t){let e=r.querySelectorAll(".option-input"),s=[],a=[];e.forEach(e=>{var t,n=e.value.trim();n&&(t=s.length,s.push(n),n=e.parentElement.querySelector(".correct-checkbox"))&&n.checked&&a.push(t)}),s.length<2?showMessage("Bitte füge mindestens zwei gültige Optionen hinzu","error"):0!==a.length?(i.questions.push({question:t,options:s,correct:a}),o.value="",r.querySelectorAll(".option-group").forEach((e,t)=>{var n=e.querySelector(".option-input"),s=e.querySelector(".correct-checkbox");t<2?(n&&(n.value=""),s&&(s.checked=!1)):e.remove()}),A()):showMessage("Bitte wähle mindestens eine richtige Antwort aus","error")}else showMessage("Bitte gebe eine Frage ein","error")}),l.addEventListener("click",async()=>{if(0===i.questions.length)showMessage("Bitte füge mindestens eine Frage hinzu.","error");else{var e=parseInt(t.value,10);if(isNaN(e)||e<5||60<e)showMessage("Bitte gebe eine gültige Fragedauer zwischen 5 und 60 Sekunden ein.","error");else{i.questionDuration=e,i.shuffledQuestions=[...i.questions],shuffleArray(i.shuffledQuestions);{let e=generateAlphanumericId(4);hostRoomId=e,i.roomId=e.substring(0,2)+" "+e.substring(2,4),hostPlayerId="host-"+generateAlphanumericId(12);try{let{data:e,error:t}=await supabaseClient.from("rooms").insert([{id:hostRoomId,current_question_index:i.currentQuestionIndex,quiz_state:{is_active:!1,question_duration:i.questionDuration},host_player_id:hostPlayerId}]);if(t)throw t;console.log("Room created in Supabase:",e);var{data:n,error:s}=await supabaseClient.from("players").insert([{id:hostPlayerId,room_id:hostRoomId,name:"Host",score:0,is_connected:!0}]);if(s)throw s;console.log("Host player created:",n),i.players[hostPlayerId]={id:hostPlayerId,name:"Host",score:0,currentAnswer:[],answerTime:null},M(),hostPlayersSubscription=supabaseClient.channel("players_in_room_"+hostRoomId).on("postgres_changes",{event:"*",schema:"public",table:"players",filter:"room_id=eq."+hostRoomId},e=>{if("INSERT"===e.eventType)e.new.id!==hostPlayerId&&(console.log("New player joined:",e.new),i.players[e.new.id]={id:e.new.id,name:e.new.name,score:e.new.score,currentAnswer:[],answerTime:null},M());else if("UPDATE"===e.eventType){if(e.new.id!==hostPlayerId){var t=e.new,n=t.id;if(console.log("Host received player data update from",n,t),i.players[n]&&i.isQuestionActive){i.shuffledQuestions[i.currentQuestionIndex];let e=i.players[n].currentAnswer&&JSON.stringify(i.players[n].currentAnswer)===JSON.stringify(t.last_answer_data);if(t.last_answer_data&&!e){i.answersReceived++;let e=((t.last_answer_time?new Date(t.last_answer_time).getTime():Date.now())-hostQuestionStartTime)/1e3;i.players[n].answerTime=e,i.players[n].currentAnswer=t.last_answer_data,C.textContent=i.answersReceived.toString();n=Object.values(i.players).filter(e=>e.id!==hostPlayerId);i.answersReceived>=n.length&&H()}}else n===hostPlayerId||i.players[n]||(i.players[n]={id:n,name:t.name,score:t.score||0,currentAnswer:t.last_answer_data||[],answerTime:t.last_answer_time?(new Date(t.last_answer_time).getTime()-hostQuestionStartTime)/1e3:null},M()),n!==hostPlayerId&&(i.players[n].score=t.score||0,i.players[n].is_connected=t.is_connected,M())}}else"DELETE"===e.eventType&&(console.log("Player disconnected (deleted):",e.old.id),i.players[e.old.id])&&(delete i.players[e.old.id],M(),n=Object.values(i.players).filter(e=>e.id!==hostPlayerId),i.isQuestionActive&&i.answersReceived>=n.length&&H())}).subscribe();var{data:a,error:r}=await supabaseClient.from("players").select("*").eq("room_id",hostRoomId).eq("is_connected",!0);if(r)throw r;a.forEach(e=>{e.id!==hostPlayerId&&(i.players[e.id]={id:e.id,name:e.name,score:e.score||0,currentAnswer:e.last_answer_data||[],answerTime:e.last_answer_time?(new Date(e.last_answer_time).getTime()-hostQuestionStartTime)/1e3:null})}),M(),(hostSupabaseChannel=supabaseClient.channel("quiz_room_"+hostRoomId)).subscribe(e=>{"SUBSCRIBED"===e?(console.log("Host subscribed to broadcast channel:","quiz_room_"+hostRoomId),c.classList.add("hidden"),d.classList.remove("hidden"),h.textContent=i.roomId,Q(k(hostRoomId)),hostViewHeading&&hostViewHeading.classList.remove("hidden")):"CHANNEL_ERROR"===e&&(console.error("Host channel error:",e),showMessage("Fehler beim Verbinden mit dem Quiz-Raum. Bitte versuche es erneut.","error"),D())})}catch(e){console.error("Error initializing host Supabase:",e),showMessage(`Fehler beim Starten des Hosts: ${e.message}. Bitte überprüfe deine Supabase-Konfiguration und versuche es erneut.`,"error"),D()}}}}}),g.addEventListener("click",async()=>{0!==Object.keys(i.players).filter(e=>e!==hostPlayerId).length?(d.classList.add("hidden"),f.classList.remove("hidden"),hostViewHeading&&hostViewHeading.classList.add("hidden"),i.currentQuestionIndex=0,await O()):showMessage("Es sind noch keine Spieler beigetreten!","info")}),q.addEventListener("click",async()=>{i.currentQuestionIndex++,await O()}),B.addEventListener("click",F),z.addEventListener("click",async()=>{hostSupabaseChannel&&(await supabaseClient.removeChannel(hostSupabaseChannel),hostSupabaseChannel=null),hostPlayersSubscription&&(await supabaseClient.removeChannel(hostPlayersSubscription),hostPlayersSubscription=null),hostRoomId&&(await supabaseClient.from("players").delete().eq("room_id",hostRoomId),await supabaseClient.from("rooms").delete().eq("id",hostRoomId)),hostGlobalQuizState=null,isHostInitialized=!1,n.textContent="",e&&(e.value=""),x.classList.add("hidden"),f.classList.add("hidden"),d.classList.add("hidden"),c.classList.remove("hidden"),document.getElementById("role-selection").classList.remove("hidden"),hostViewHeading&&hostViewHeading.classList.remove("hidden"),initializeHostFeatures()}),window.addEventListener("beforeunload",async()=>{hostSupabaseChannel&&await supabaseClient.removeChannel(hostSupabaseChannel),hostPlayersSubscription&&await supabaseClient.removeChannel(hostPlayersSubscription),hostPlayerId&&await supabaseClient.from("players").update({is_connected:!1}).eq("id",hostPlayerId)}),u.addEventListener("click",()=>{qrModalOverlay&&largeQrcodeContainer&&hostRoomId&&(qrModalOverlay.classList.remove("hidden"),largeQrcodeContainer.innerHTML="",new QRCode(largeQrcodeContainer,{text:m.href,width:300,height:300,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),modalRoomIdSpan.textContent=i.roomId)}),isHostInitialized=!0),A(),M(),hostRoomId)if(i.isQuestionActive||i.currentQuestionIndex<i.shuffledQuestions.length){c.classList.add("hidden"),d.classList.add("hidden"),x.classList.add("hidden"),f.classList.remove("hidden"),hostViewHeading&&hostViewHeading.classList.add("hidden");let e=i.shuffledQuestions[i.currentQuestionIndex];w.textContent=e.question,R(e.shuffledOptions||e.options,[]),v.textContent=`Frage ${i.currentQuestionIndex+1} von `+i.shuffledQuestions.length,C.textContent=i.answersReceived.toString(),L.textContent=Object.values(i.players).filter(e=>e.id!==hostPlayerId).length.toString(),(i.currentQuestionIndex<i.shuffledQuestions.length-1?q:B).classList.remove("hidden")}else x.classList.contains("active")?(c.classList.add("hidden"),d.classList.add("hidden"),f.classList.add("hidden"),x.classList.remove("hidden"),hostViewHeading&&hostViewHeading.classList.remove("hidden"),V()):(c.classList.add("hidden"),d.classList.remove("hidden"),hostViewHeading&&hostViewHeading.classList.remove("hidden"),Q(k(hostRoomId)),h.textContent=i.roomId||"N/A");else c.classList.remove("hidden"),d.classList.add("hidden"),f.classList.add("hidden"),x.classList.add("hidden"),hostViewHeading&&hostViewHeading.classList.remove("hidden");function A(){if(a.innerHTML="",0===i.questions.length)return a.innerHTML="<p>Noch keine Fragen hinzugefügt</p>",l.classList.add("hidden");i.questions.forEach((e,t)=>{var n=document.createElement("div"),s=(n.className="question-item",e.correct.map(e=>e+1).join(", "));n.innerHTML=`
                        <p><strong>F${t+1}:</strong> ${e.question}</p>
                        <p><strong>Optionen:</strong> ${e.options.join("; ")}</p>
                        <p><strong>Richtige Option(en):</strong> ${s}</p>
                        <button class="btn remove-question" data-index="${t}">Entfernen</button>
                    `,a.appendChild(n)}),document.querySelectorAll(".remove-question").forEach(e=>{e.onclick=e=>{e=parseInt(e.target.getAttribute("data-index"));i.questions.splice(e,1),A()}}),l.classList.remove("hidden")}async function M(){try{var{data:n,error:s}=await supabaseClient.from("players").select("id, name, score").eq("room_id",hostRoomId).eq("is_connected",!0);if(s)throw s;let e=n.filter(e=>e.id!==hostPlayerId),t={};e.forEach(e=>{t[e.id]={id:e.id,name:e.name,score:e.score||0,currentAnswer:i.players[e.id]?.currentAnswer||[],answerTime:i.players[e.id]?.answerTime||null}}),i.players[hostPlayerId]&&(t[hostPlayerId]=i.players[hostPlayerId]),i.players=t;var a=e.length;P.textContent=a.toString(),L.textContent=a.toString(),y.innerHTML="",e.forEach(e=>{var t=document.createElement("div");t.className="player-item",t.textContent=e.name,y.appendChild(t)}),g.classList.toggle("hidden",0===a)}catch(e){console.error("Error updating players list from Supabase:",e)}}function Q(t){if(u.innerHTML="","undefined"==typeof QRCode)return console.error("QR-Code-Bibliothek nicht geladen."),u.innerHTML=`<p style="color:red;">QR-Code-Bibliothek nicht geladen. URL: ${t}</p>`;try{new QRCode(u,{text:t,width:240,height:240,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H})}catch(e){console.error("QR Code generation error:",e),u.innerHTML=`<p style="color:red;">Fehler beim Generieren des QR-Codes. URL: ${t}</p>`}}function k(e){e=window.location.origin+window.location.pathname.split("?")[0]+"?host="+e;return m.href=e,m.textContent=e,p.href=e,p.textContent=e}async function O(){if(i.currentQuestionIndex>=i.shuffledQuestions.length)F();else{let e=i.shuffledQuestions[i.currentQuestionIndex],n=(i.answersReceived=0,i.isQuestionActive=!0,hostQuestionStartTime=Date.now(),e.options.map((e,t)=>({text:e,originalIndex:t})));shuffleArray(n);var s=n.map(e=>e.text),t=e.correct.map(t=>n.findIndex(e=>e.originalIndex===t));e.shuffledOptions=s,e.shuffledCorrect=t;for(let t of Object.values(i.players))if(t.currentAnswer=[],t.answerTime=null,t.id!==hostPlayerId)try{await supabaseClient.from("players").update({last_answer_data:[],last_answer_time:null}).eq("id",t.id)}catch(e){console.error(`Error resetting player ${t.name}'s answer:`,e)}w.textContent=e.question,R(s,[]),v.textContent=`Frage ${i.currentQuestionIndex+1} von `+i.shuffledQuestions.length,C.textContent="0";t=Object.values(i.players).filter(e=>e.id!==hostPlayerId).length;L.textContent=t.toString(),q.classList.add("hidden"),B.classList.add("hidden"),E.classList.add("hidden"),hostViewHeading&&hostViewHeading.classList.add("hidden");{s=i.questionDuration;b.style.width="100%",hostTimerInterval&&clearInterval(hostTimerInterval);let t=1e3*s,n=Date.now();hostTimerInterval=setInterval(()=>{var e=Date.now()-n,e=Math.max(0,t-e);b.style.width=e/t*100+"%",e<=0&&H()},100)}t=e;t={type:"question",question:t.question,options:t.shuffledOptions,correct:t.shuffledCorrect,index:i.currentQuestionIndex,total:i.shuffledQuestions.length,startTime:hostQuestionStartTime,duration:i.questionDuration};try{await supabaseClient.from("rooms").update({current_question_index:i.currentQuestionIndex,quiz_state:{is_active:!0,question_duration:i.questionDuration}}).eq("id",hostRoomId),await hostSupabaseChannel.send({type:"broadcast",event:"quiz_event",payload:t}),console.log("Question broadcasted:",t)}catch(e){console.error("Error sending question via Supabase:",e),showMessage("Fehler beim Senden der Frage. Bitte überprüfe deine Supabase-Verbindung.","error")}}}function R(e,t=[],a=[]){I.innerHTML="";let r=new Set(t);e.forEach((e,t)=>{var n=document.createElement("li");let s=e;a&&void 0!==a[t]&&(s+=` (${a[t]}x gewählt)`),n.textContent=s,r.has(t)&&n.classList.add("correct"),I.appendChild(n)})}async function H(){if(i.isQuestionActive){hostTimerInterval&&(clearInterval(hostTimerInterval),hostTimerInterval=null),i.isQuestionActive=!1;let e=i.shuffledQuestions[i.currentQuestionIndex],t=Array(e.shuffledOptions.length).fill(0);Object.values(i.players).filter(e=>e.id!==hostPlayerId).forEach(e=>{e.currentAnswer&&Array.isArray(e.currentAnswer)&&e.currentAnswer.forEach(e=>{void 0!==t[e]&&t[e]++})}),R(e.shuffledOptions,e.shuffledCorrect,t);{let e=i.shuffledQuestions[i.currentQuestionIndex],t=new Set(e.shuffledCorrect),s=i.questionDuration,n=i.shuffledQuestions.length,a=100;if(1<n){let e=200/(n-1);a=100+i.currentQuestionIndex*e}Object.values(i.players).forEach(n=>{if(n.id!==hostPlayerId&&n.currentAnswer&&0<n.currentAnswer.length){var e=new Set(n.currentAnswer);if(t.size===e.size&&[...e].every(e=>t.has(e))){let e=null!==n.answerTime?n.answerTime:s,t=Math.max(0,s-e)/s*(.5*a);n.score+=a+t}}})}{let e=i.shuffledQuestions[i.currentQuestionIndex],t=i.currentQuestionIndex===i.shuffledQuestions.length-1,n=T();for(let t of Object.values(i.players))if(t.id!==hostPlayerId)try{await supabaseClient.from("players").update({score:t.score}).eq("id",t.id)}catch(e){console.error(`Error updating player ${t.name}'s score in Supabase:`,e)}var s={type:"result",correct:e.shuffledCorrect,isFinal:t,options:e.shuffledOptions,leaderboard:n};try{await hostSupabaseChannel.send({type:"broadcast",event:"quiz_event",payload:s}),console.log("Results broadcasted.")}catch(e){console.error("Error broadcasting results via Supabase:",e),showMessage("Fehler beim Senden der Ergebnisse. Bitte überprüfe deine Supabase-Verbindung.","error")}}await 0,s=T(),S.innerHTML="",E.classList.remove("hidden"),0===(s=s.slice(0,10)).length?S.innerHTML="<li>Noch keine Spieler.</li>":s.forEach((e,t)=>{var n=document.createElement("li");n.className="scoreboard-item",0===t?n.classList.add("rank-1"):1===t?n.classList.add("rank-2"):2===t&&n.classList.add("rank-3"),n.innerHTML=`<span>${t+1}. ${e.name}</span><span>${Math.round(e.score)} Punkte</span>`,S.appendChild(n)}),i.currentQuestionIndex<i.shuffledQuestions.length-1?(q.classList.remove("hidden"),B.classList.add("hidden")):(q.classList.add("hidden"),B.classList.remove("hidden"))}}function F(){f.classList.add("hidden"),x.classList.remove("hidden"),hostViewHeading&&hostViewHeading.classList.remove("hidden"),V()}function T(){return Object.values(i.players).filter(e=>e.id!==hostPlayerId).map(e=>({name:e.name,score:e.score})).sort((e,t)=>t.score-e.score)}function V(){var e=T();_.innerHTML="",0!==e.length?e.forEach((e,t)=>{var n=document.createElement("div");n.className="leaderboard-item",0===t?n.classList.add("rank-1"):1===t?n.classList.add("rank-2"):2===t&&n.classList.add("rank-3"),n.innerHTML=`<span>${t+1}. ${e.name}</span><span>${Math.round(e.score)} Punkte</span>`,_.appendChild(n)}):_.innerHTML="<p>Noch keine Spieler in der Rangliste.</p>"}async function D(){hostSupabaseChannel&&(await supabaseClient.removeChannel(hostSupabaseChannel),hostSupabaseChannel=null),hostPlayersSubscription&&(await supabaseClient.removeChannel(hostPlayersSubscription),hostPlayersSubscription=null),hostGlobalQuizState=null,isHostInitialized=!1,hostRoomId=null,hostPlayerId=null,n.textContent="",e&&(e.value=""),x.classList.add("hidden"),f.classList.add("hidden"),d.classList.add("hidden"),c.classList.remove("hidden"),document.getElementById("role-selection").classList.remove("hidden"),hostViewHeading&&hostViewHeading.classList.remove("hidden"),initializeHostFeatures()}}let playerSupabaseChannel=null,playerRoomId=null,playerCurrentId=null,isPlayerInitialized=!1,playerTimerInterval=null,playerCurrentQuestionOptions=[],selectedAnswers=[],playerScore=0,playerQuestionStartTime=null;function triggerConfetti(){var t=document.getElementById("confetti-container");if(t){var n=["#f44336","#e91e63","#9c27b0","#673ab7","#3f51b5","#2196f3","#03a9f4","#00bcd4","#009688","#4CAF50","#8bc34a","#cddc39","#ffeb3b","#ffc107","#ff9800","#ff5722"];for(let e=0;e<50;e++){let e=document.createElement("div");e.className="confetti-piece",e.style.left=100*Math.random()+"vw",e.style.top=-20-100*Math.random()+"px",e.style.backgroundColor=n[Math.floor(Math.random()*n.length)],e.style.animationDelay=.5*Math.random()+"s",e.style.animationDuration=2+2*Math.random()+"s",t.appendChild(e),e.addEventListener("animationend",()=>{e.remove()})}}else console.warn("Confetti-Container nicht gefunden.")}function initializePlayerFeatures(){console.log("Initializing Player Features. Initialized flag:",isPlayerInitialized);let s=document.getElementById("room-code-input"),a=document.getElementById("player-name-input"),e=document.getElementById("join-btn"),r=document.getElementById("join-form"),i=document.getElementById("waiting-room"),o=document.getElementById("waiting-message"),l=document.getElementById("player-question"),d=document.getElementById("player-question-text"),c=document.getElementById("player-question-counter"),u=document.getElementById("player-timer-bar"),h=document.getElementById("options-container"),m=document.getElementById("submit-answer-btn"),p=document.getElementById("player-result"),y=document.getElementById("result-display"),g=document.getElementById("player-score"),f=document.getElementById("waiting-for-next"),n=document.getElementById("player-final-result"),w=document.getElementById("final-score"),t=document.getElementById("play-again-btn"),I=document.getElementById("player-leaderboard-container");function v(e,t,n){l.classList.add("hidden"),p.classList.remove("hidden");let s="Deine Antwort war ",a=new Set(t||[]),r=new Set(e.correct),i=e.options;e=r.size===a.size&&[...a].every(e=>r.has(e));t&&0!==t.length?e?(s+='<strong class="correct">RICHTIG!</strong> ',triggerConfetti()):s+='<strong class="incorrect">FALSCH.</strong> ':s="Du hast nicht geantwortet. ",s+="<br>Richtige Antwort(en): ",i.forEach((e,t)=>{r.has(t)?a.has(t)?s+=`<span class="correct player-selected">"${e}"</span> `:s+=`<span class="correct-not-selected">"${e}"</span> `:a.has(t)}),y.innerHTML=s,g.textContent=Math.round(n),h.querySelectorAll("button.option-btn").forEach(e=>{var t=parseInt(e.dataset.index);e.disabled=!0,e.classList.remove("selected"),r.has(t)&&e.classList.add("correct-answer"),a.has(t)&&r.has(t)&&e.classList.add("selected")})}function b(e){if(console.log("Displaying final results for player:",e),l.classList.add("hidden"),p.classList.add("hidden"),i.classList.add("hidden"),n.classList.remove("hidden"),w.textContent=Math.round(playerScore),I.innerHTML="",e.leaderboard){var t=document.createElement("div");t.innerHTML="<h4>Endgültige Rangliste:</h4>";let s=document.createElement("ol");0===e.leaderboard.length?s.innerHTML="<li>Keine Spieler in der Rangliste.</li>":e.leaderboard.forEach((e,t)=>{var n=document.createElement("li");0===t?n.classList.add("rank-1"):1===t?n.classList.add("rank-2"):2===t&&n.classList.add("rank-3"),n.textContent=`${t+1}. ${e.name}: ${Math.round(e.score)} Punkte`,s.appendChild(n)}),t.appendChild(s),I.appendChild(t)}else I.innerHTML="<p>Keine Ranglistendaten verfügbar.</p>"}async function C(){playerSupabaseChannel&&(await supabaseClient.removeChannel(playerSupabaseChannel),playerSupabaseChannel=null),playerCurrentId&&await supabaseClient.from("players").update({is_connected:!1}).eq("id",playerCurrentId),playerScore=0,selectedAnswers=[],playerCurrentQuestionOptions=[],playerQuestionStartTime=null,playerRoomId=null,playerCurrentId=null,s.value="",a.value="",r.classList.remove("hidden"),i.classList.add("hidden"),l.classList.add("hidden"),p.classList.add("hidden"),n.classList.add("hidden"),h.innerHTML="",y.innerHTML="",I.innerHTML="",g.textContent="0",w.textContent="0"}isPlayerInitialized||(console.log("Setting up player event listeners for the first time."),e.addEventListener("click",async()=>{var n=s.value.trim().replace(/\s/g,""),e=a.value.trim()||"Spieler "+generateAlphanumericId(4);if(n){var t=n,n=e;playerRoomId=t,playerCurrentId="player-"+generateAlphanumericId(12),r.classList.add("hidden"),i.classList.remove("hidden"),o.textContent=`Verbinde mit Raum ${playerRoomId}...`;try{let{data:e,error:t}=await supabaseClient.from("rooms").select("id").eq("id",playerRoomId).single();if(t||!e)showMessage("Raum nicht gefunden oder Fehler beim Abrufen des Raums. Bitte überprüfe den Code.","error"),C();else{let{data:e,error:t}=await supabaseClient.from("players").insert([{id:playerCurrentId,room_id:playerRoomId,name:n,score:0,is_connected:!0}]);if(t)throw t;console.log("Player joined Supabase:",e),(playerSupabaseChannel=supabaseClient.channel("quiz_room_"+playerRoomId)).on("broadcast",{event:"quiz_event"},e=>{(async e=>{switch(console.log("Player received data from host:",e),e.type){case"question":playerCurrentQuestionOptions=e.options,selectedAnswers=[],playerQuestionStartTime=Date.now(),s=e,i.classList.add("hidden"),p.classList.add("hidden"),l.classList.remove("hidden"),d.textContent=s.question,c.textContent=`Frage ${s.index+1} von `+s.total,h.innerHTML="",selectedAnswers=[],s.options.forEach((e,t)=>{let n=document.createElement("button");n.className="option-btn",n.textContent=e,n.dataset.index=t,n.addEventListener("click",()=>{var e=parseInt(n.dataset.index),t=selectedAnswers.indexOf(e);-1<t?(selectedAnswers.splice(t,1),n.classList.remove("selected")):(selectedAnswers.push(e),n.classList.add("selected")),m.classList.toggle("hidden",0===selectedAnswers.length)}),h.appendChild(n)}),m.classList.add("hidden"),m.disabled=!1,h.querySelectorAll("button.option-btn").forEach(e=>{e.disabled=!1,e.classList.remove("correct-answer","incorrect-answer","selected")});{s=e.duration;u.style.width="100%",playerTimerInterval&&clearInterval(playerTimerInterval);let t=1e3*s,n=Date.now();playerTimerInterval=setInterval(()=>{var e=Date.now()-n,e=Math.max(0,t-e);u.style.width=e/t*100+"%",e<=0&&(clearInterval(playerTimerInterval),playerTimerInterval=null,m.classList.add("hidden"),h.querySelectorAll("button.option-btn").forEach(e=>e.disabled=!0),console.log("Player timer up."),0===selectedAnswers.length)&&(supabaseClient.from("players").update({last_answer_data:[],last_answer_time:(new Date).toISOString()}).eq("id",playerCurrentId),console.log("Player sent empty answer due to timeout."))},100)}break;case"result":var{data:s,error:t}=await supabaseClient.from("players").select("score, last_answer_data").eq("id",playerCurrentId).single();t?(console.error("Error fetching player data for result display:",t),v(e,selectedAnswers,playerScore)):(playerScore=s.score||0,v(e,s.last_answer_data||[],playerScore)),f.textContent=e.isFinal?"Warten auf Endergebnisse...":"Warten auf nächste Frage...",e.isFinal&&b(e);break;case"final":b(e);break;case"quiz_terminated":showMessage("Der Host hat das Quiz beendet.","info"),C(),showView("role-selection")}})(e.payload)}).subscribe(e=>{"SUBSCRIBED"===e?(console.log("Player subscribed to broadcast channel:","quiz_room_"+playerRoomId),o.textContent="Verbunden! Warte auf Host..."):"CHANNEL_ERROR"===e&&(console.error("Player channel error:",e),showMessage("Fehler beim Verbinden mit dem Quiz-Raum. Bitte versuche es erneut.","error"),C())})}}catch(t){console.error("Error initializing player Supabase:",t),showMessage(`Fehler beim Beitreten des Quiz: ${t.message}.`,"error"),C()}}else showMessage("Bitte gib einen Raum-Code ein.","error")}),m.addEventListener("click",async()=>{if(0!==selectedAnswers.length){m.disabled=!0,h.querySelectorAll("button.option-btn").forEach(e=>e.disabled=!0),console.log("Player submitted answer:",selectedAnswers),playerTimerInterval&&(clearInterval(playerTimerInterval),playerTimerInterval=null);try{await supabaseClient.from("players").update({last_answer_data:selectedAnswers,last_answer_time:(new Date).toISOString()}).eq("id",playerCurrentId),console.log("Player answer updated in Supabase.")}catch(e){console.error("Error updating player answer in Supabase:",e),showMessage("Fehler beim Absenden der Antwort. Bitte versuche es erneut.","error")}}else showMessage("Bitte wähle mindestens eine Antwort aus.","info")}),t.addEventListener("click",()=>{C(),isPlayerInitialized=!1,showView("role-selection")}),window.addEventListener("beforeunload",async()=>{playerSupabaseChannel&&await supabaseClient.removeChannel(playerSupabaseChannel),playerCurrentId&&await supabaseClient.from("players").update({is_connected:!1}).eq("id",playerCurrentId)}),isPlayerInitialized=!0),s.value="",a.value="",r.classList.remove("hidden"),i.classList.add("hidden"),l.classList.add("hidden"),p.classList.add("hidden"),n.classList.add("hidden")}</script></body></html>